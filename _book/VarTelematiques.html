<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Telematics and Algorithmic Bias - 4&nbsp; Telematic Covariates</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./severity.html" rel="next">
<link href="./VarTraditionelles.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="custom.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./DataSummary.html">Claim Frequency</a></li><li class="breadcrumb-item"><a href="./VarTelematiques.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Telematic Covariates</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./images/Cars.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Telematics and Algorithmic Bias</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Theoretical concepts</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Claim Frequency</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./DataSummary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Summary</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./VarTraditionelles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Traditional Covariates</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./VarTelematiques.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Telematic Covariates</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Claim Severity</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./severity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Data Summary</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./severityVarTrad.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Traditional Covariates</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./severityVarTelematique.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Telematic Covariates</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Discussion</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Discussion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Appendix</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Proposal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Initial Proposal</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#preamble" id="toc-preamble" class="nav-link active" data-scroll-target="#preamble"><span class="header-section-number">4.1</span> Preamble</a></li>
  <li><a href="#basic-glm-models" id="toc-basic-glm-models" class="nav-link" data-scroll-target="#basic-glm-models"><span class="header-section-number">4.2</span> Basic GLM Models</a></li>
  <li><a href="#glm-net" id="toc-glm-net" class="nav-link" data-scroll-target="#glm-net"><span class="header-section-number">4.3</span> GLM-Net</a>
  <ul class="collapse">
  <li><a href="#parametric-transformation-of-continuous-covariates" id="toc-parametric-transformation-of-continuous-covariates" class="nav-link" data-scroll-target="#parametric-transformation-of-continuous-covariates"><span class="header-section-number">4.3.1</span> Parametric transformation of continuous covariates</a></li>
  <li><a href="#fitting-the-glm-net-model" id="toc-fitting-the-glm-net-model" class="nav-link" data-scroll-target="#fitting-the-glm-net-model"><span class="header-section-number">4.3.2</span> Fitting the GLM-Net model</a></li>
  </ul></li>
  <li><a href="#xgboost" id="toc-xgboost" class="nav-link" data-scroll-target="#xgboost"><span class="header-section-number">4.4</span> XGBoost</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Telematic Covariates</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="preamble" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="preamble"><span class="header-section-number">4.1</span> Preamble</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">Chapter Objective</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Packages</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">Data</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false">Data Transformation</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>We continue the analysis of claim frequency by adding telematic variables to the same three approaches of the last chapter. However, we will remove protected traditional variables from our analysis. Specifically, we will not use the following five covariates in our models:</p>
<ol type="1">
<li>Credit.score,<br>
</li>
<li>Insured.age,<br>
</li>
<li>Insured.sex,<br>
</li>
<li>Marital,<br>
</li>
<li>Territory.</li>
</ol>
<p>The objective is to assess the performance of ratemaking approaches incorporating telematics information without protected covariates. By analyzing the residuals of the approach, we will gauge the relevance of those protected covariates.</p>
<p>To compare models, we will employ the following functions that calculate predictive scores:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>Score.pred <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, x) {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  Sc.log  <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dpois</span>(x, mu, <span class="at">log=</span><span class="cn">TRUE</span>))</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  Sc.MSE  <span class="ot">&lt;-</span> <span class="fu">sum</span>((x <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  Sc.quad <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span><span class="fu">dpois</span>(x,<span class="at">lambda=</span>mu) <span class="sc">+</span> <span class="fu">sapply</span>(mu, <span class="cf">function</span>(x){ <span class="fu">sum</span>(<span class="fu">dpois</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>,<span class="at">lambda=</span>x)<span class="sc">^</span><span class="dv">2</span>) }))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  Sc.sph <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">-</span> <span class="fu">dpois</span>(x,mu) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sapply</span>(mu, <span class="cf">function</span>(x){ <span class="fu">sum</span>(<span class="fu">dpois</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>,<span class="at">lambda=</span>x)<span class="sc">^</span><span class="dv">2</span>) })))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  Sc.DSS <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dss_pois</span>(x, mu))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  Sc.CRPS <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">crps_pois</span>(x, mu))</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(Sc.log, Sc.MSE, Sc.quad, Sc.sph, Sc.DSS, Sc.CRPS))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>Here is the list of packages that will be used:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vtable)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(repr)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gam)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scoringRules)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sjPlot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<p>The same data is used.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>dataS <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">'Data/Synthetic.csv'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Modifications </span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>dataS <span class="ot">&lt;-</span> dataS <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Territory =</span> <span class="fu">as.factor</span>(Territory)) <span class="sc">%&gt;%</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">'Annual.pct.driven'</span>, <span class="st">'Annual.miles.drive'</span>))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>data.select <span class="ot">&lt;-</span> dataS</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Train-test </span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> data.select <span class="sc">%&gt;%</span> <span class="fu">sample_frac</span>(<span class="fl">0.8</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> data.select <span class="sc">%&gt;%</span> <span class="fu">anti_join</span>(train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<p>As we concluded at the end of our overview of the data, a transformation of certain variables is also necessary.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modif data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> train <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Miles.per.day =</span> Total.miles.driven<span class="sc">/</span>Duration,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">max.day =</span> <span class="fu">pmax</span>(Pct.drive.mon, Pct.drive.tue, Pct.drive.wed, Pct.drive.thr, Pct.drive.fri, Pct.drive.sat, Pct.drive.sun),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">min.day =</span> <span class="fu">pmin</span>(Pct.drive.mon, Pct.drive.tue, Pct.drive.wed, Pct.drive.thr, Pct.drive.fri, Pct.drive.sat, Pct.drive.sun),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">max.min =</span> max.day <span class="sc">-</span> min.day,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="st">'Monday'</span>, </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="fu">ifelse</span>(max.day <span class="sc">==</span> Pct.drive.tue, <span class="st">'Tuesday'</span>, Dayformax),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="fu">ifelse</span>(max.day <span class="sc">==</span> Pct.drive.wed, <span class="st">'Wednesday'</span>, Dayformax),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="fu">ifelse</span>(max.day <span class="sc">==</span> Pct.drive.thr, <span class="st">'Thursday'</span>, Dayformax),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="fu">ifelse</span>(max.day <span class="sc">==</span> Pct.drive.fri, <span class="st">'Friday'</span>, Dayformax),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="fu">ifelse</span>(max.day <span class="sc">==</span> Pct.drive.sat, <span class="st">'Saturday'</span>, Dayformax),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="fu">ifelse</span>(max.day <span class="sc">==</span> Pct.drive.sun, <span class="st">'Sunday'</span>, Dayformax),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="st">'Monday'</span>, </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="fu">ifelse</span>(min.day <span class="sc">==</span> Pct.drive.tue, <span class="st">'Tuesday'</span>, Dayformin),</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="fu">ifelse</span>(min.day <span class="sc">==</span> Pct.drive.wed, <span class="st">'Wednesday'</span>, Dayformin),</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="fu">ifelse</span>(min.day <span class="sc">==</span> Pct.drive.thr, <span class="st">'Thursday'</span>, Dayformin),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="fu">ifelse</span>(min.day <span class="sc">==</span> Pct.drive.fri, <span class="st">'Friday'</span>, Dayformin),</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="fu">ifelse</span>(min.day <span class="sc">==</span> Pct.drive.sat, <span class="st">'Saturday'</span>, Dayformin),</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="fu">ifelse</span>(min.day <span class="sc">==</span> Pct.drive.sun, <span class="st">'Sunday'</span>, Dayformin),</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">expo =</span> Duration<span class="sc">/</span><span class="fl">365.25</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>transform.fct <span class="ot">&lt;-</span> <span class="cf">function</span>(var){</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">var_ =</span> <span class="fu">get</span>(var)<span class="sc">*</span>Total.miles.driven<span class="sc">/</span>(<span class="dv">1000</span><span class="sc">*</span>Duration))</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  q99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(df<span class="sc">$</span>var_, <span class="fl">0.99</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">var_ =</span> <span class="fu">ifelse</span>(var_ <span class="sc">&gt;</span> q99, q99, var_))</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">#colnames(df)[ncol(df)] &lt;- paste0(var, '_')</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Brake.06miles"</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Brake.08miles"</span>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Brake.09miles"</span>)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Brake.11miles"</span>)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Brake.14miles"</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Accel.06miles"</span>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Accel.08miles"</span>)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Accel.09miles"</span>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Accel.11miles"</span>)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Accel.12miles"</span>)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Accel.14miles"</span>)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Left.turn.intensity08"</span>)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Left.turn.intensity09"</span>)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Left.turn.intensity10"</span>)</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Left.turn.intensity11"</span>)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Left.turn.intensity12"</span>)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Right.turn.intensity08"</span>)</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Right.turn.intensity09"</span>)</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Right.turn.intensity10"</span>)</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Right.turn.intensity11"</span>)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Right.turn.intensity12"</span>)</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Create folds</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>nb.fold <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>fold <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>nb.fold, <span class="fu">nrow</span>(train2), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>train2<span class="sc">$</span>fold <span class="ot">&lt;-</span> fold</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Miles.per.day =</span> Total.miles.driven<span class="sc">/</span>Duration,</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>         <span class="at">max.day =</span> <span class="fu">pmax</span>(Pct.drive.mon, Pct.drive.tue, Pct.drive.wed, Pct.drive.thr, Pct.drive.fri, Pct.drive.sat, Pct.drive.sun),</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>         <span class="at">min.day =</span> <span class="fu">pmin</span>(Pct.drive.mon, Pct.drive.tue, Pct.drive.wed, Pct.drive.thr, Pct.drive.fri, Pct.drive.sat, Pct.drive.sun),</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>         <span class="at">max.min =</span> max.day <span class="sc">-</span> min.day,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="st">'Monday'</span>, </span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="fu">ifelse</span>(max.day <span class="sc">==</span> Pct.drive.tue, <span class="st">'Tuesday'</span>, Dayformax),</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="fu">ifelse</span>(max.day <span class="sc">==</span> Pct.drive.wed, <span class="st">'Wednesday'</span>, Dayformax),</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="fu">ifelse</span>(max.day <span class="sc">==</span> Pct.drive.thr, <span class="st">'Thursday'</span>, Dayformax),</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="fu">ifelse</span>(max.day <span class="sc">==</span> Pct.drive.fri, <span class="st">'Friday'</span>, Dayformax),</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="fu">ifelse</span>(max.day <span class="sc">==</span> Pct.drive.sat, <span class="st">'Saturday'</span>, Dayformax),</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformax =</span> <span class="fu">ifelse</span>(max.day <span class="sc">==</span> Pct.drive.sun, <span class="st">'Sunday'</span>, Dayformax),</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="st">'Monday'</span>, </span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="fu">ifelse</span>(min.day <span class="sc">==</span> Pct.drive.tue, <span class="st">'Tuesday'</span>, Dayformin),</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="fu">ifelse</span>(min.day <span class="sc">==</span> Pct.drive.wed, <span class="st">'Wednesday'</span>, Dayformin),</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="fu">ifelse</span>(min.day <span class="sc">==</span> Pct.drive.thr, <span class="st">'Thursday'</span>, Dayformin),</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="fu">ifelse</span>(min.day <span class="sc">==</span> Pct.drive.fri, <span class="st">'Friday'</span>, Dayformin),</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="fu">ifelse</span>(min.day <span class="sc">==</span> Pct.drive.sat, <span class="st">'Saturday'</span>, Dayformin),</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>         <span class="at">Dayformin =</span> <span class="fu">ifelse</span>(min.day <span class="sc">==</span> Pct.drive.sun, <span class="st">'Sunday'</span>, Dayformin),</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>         <span class="at">expo =</span> Duration<span class="sc">/</span><span class="fl">365.25</span>)</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>transform.fct <span class="ot">&lt;-</span> <span class="cf">function</span>(var){</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> test2 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">var_ =</span> <span class="fu">get</span>(var)<span class="sc">*</span>Total.miles.driven<span class="sc">/</span>(<span class="dv">1000</span><span class="sc">*</span>Duration))</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>  q99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(df<span class="sc">$</span>var_, <span class="fl">0.99</span>)</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">var_ =</span> <span class="fu">ifelse</span>(var_ <span class="sc">&gt;</span> q99, q99, var_))</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>  <span class="co">#colnames(df)[ncol(df)] &lt;- paste0(var, '_')</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Brake.06miles"</span>)</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Brake.08miles"</span>)</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Brake.09miles"</span>)</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Brake.11miles"</span>)</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Brake.14miles"</span>)</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Accel.06miles"</span>)</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Accel.08miles"</span>)</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Accel.09miles"</span>)</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Accel.11miles"</span>)</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Accel.12miles"</span>)</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Accel.14miles"</span>)</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Left.turn.intensity08"</span>)</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Left.turn.intensity09"</span>)</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Left.turn.intensity10"</span>)</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Left.turn.intensity11"</span>)</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Left.turn.intensity12"</span>)</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Right.turn.intensity08"</span>)</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Right.turn.intensity09"</span>)</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Right.turn.intensity10"</span>)</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Right.turn.intensity11"</span>)</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">transform.fct</span>(<span class="st">"Right.turn.intensity12"</span>)</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean Encoding with White Noise pour les territoires</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>cardi <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(train<span class="sc">$</span>Territory))</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>enc.terr <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Territory) <span class="sc">%&gt;%</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">freq =</span> <span class="fu">sum</span>(NB_Claim)<span class="sc">/</span><span class="fu">sum</span>(expo)) <span class="sc">%&gt;%</span></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(freq) <span class="sc">%&gt;%</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">terr.code=</span> <span class="fu">row_number</span>()<span class="sc">/</span>(cardi<span class="sc">+</span><span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Territory, terr.code)</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>train2 <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Territory) <span class="sc">%&gt;%</span></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(enc.terr, <span class="at">by=</span><span class="st">'Territory'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> test2 <span class="sc">%&gt;%</span></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Territory) <span class="sc">%&gt;%</span></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(enc.terr, <span class="at">by=</span><span class="st">'Territory'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="basic-glm-models" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="basic-glm-models"><span class="header-section-number">4.2</span> Basic GLM Models</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Single intercept</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Traditional covariates already used (without protected variables)</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false">Estimated Parameters</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<p>A baseline model corresponding to a Generalized Linear Model (GLM) with intercept and predicting for each contract only the observed mean multiplied by the exposure is used as a point of comparison.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Model on each fold</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>Result_  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>Result2_  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb.fold) {</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    learn <span class="ot">&lt;-</span> train2[train2<span class="sc">$</span>fold <span class="sc">!=</span> i,]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    valid <span class="ot">&lt;-</span> train2[train2<span class="sc">$</span>fold <span class="sc">==</span> i,]</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    mean <span class="ot">&lt;-</span> <span class="fu">sum</span>(learn<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">sum</span>(learn<span class="sc">$</span>expo) </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    learn<span class="sc">$</span>pred.base <span class="ot">&lt;-</span> mean<span class="sc">*</span>learn<span class="sc">$</span>expo</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    valid<span class="sc">$</span>pred.base <span class="ot">&lt;-</span> mean<span class="sc">*</span>valid<span class="sc">$</span>expo</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    Result_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_, <span class="fu">c</span>(i, <span class="fu">Score.pred</span>(valid<span class="sc">$</span>pred.base, valid<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">nrow</span>(valid)))</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    Result2_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result2_, <span class="fu">c</span>(i, <span class="fu">Score.pred</span>(valid<span class="sc">$</span>pred.base, valid<span class="sc">$</span>NB_Claim)))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Show results</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Fold'</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result2_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Fold'</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>tot <span class="ot">&lt;-</span> <span class="fu">colSums</span>(Result2_)<span class="sc">/</span><span class="fu">nrow</span>(train2)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>tot<span class="sc">$</span>Fold <span class="ot">&lt;-</span> <span class="st">'Total'</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_ , tot)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>Result.base <span class="ot">&lt;-</span> Result_  </span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>Base <span class="ot">&lt;-</span> Result.base[nb.fold<span class="sc">+</span><span class="dv">1</span>,]</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Result_, <span class="at">align =</span> <span class="st">"ccccccc"</span>, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>), <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>))<span class="sc">%&gt;%</span>   </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> T)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-Pscore_base" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.1: Prediction scores for the base model</caption>
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Fold</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.log</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.MSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.quad</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.sph</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.DSS</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.CRPS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.18212</td>
<td style="text-align: center;">0.04666</td>
<td style="text-align: center;">-0.91794</td>
<td style="text-align: center;">-0.95797</td>
<td style="text-align: center;">-2.16359</td>
<td style="text-align: center;">0.04283</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">0.18185</td>
<td style="text-align: center;">0.04681</td>
<td style="text-align: center;">-0.91869</td>
<td style="text-align: center;">-0.95838</td>
<td style="text-align: center;">-2.14758</td>
<td style="text-align: center;">0.04263</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.17509</td>
<td style="text-align: center;">0.04555</td>
<td style="text-align: center;">-0.92361</td>
<td style="text-align: center;">-0.96096</td>
<td style="text-align: center;">-2.17549</td>
<td style="text-align: center;">0.04057</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">0.19451</td>
<td style="text-align: center;">0.05149</td>
<td style="text-align: center;">-0.91176</td>
<td style="text-align: center;">-0.95472</td>
<td style="text-align: center;">-2.06650</td>
<td style="text-align: center;">0.04650</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.18543</td>
<td style="text-align: center;">0.04832</td>
<td style="text-align: center;">-0.91673</td>
<td style="text-align: center;">-0.95733</td>
<td style="text-align: center;">-2.13131</td>
<td style="text-align: center;">0.04382</td>
</tr>
<tr class="even">
<td style="text-align: center;">Total</td>
<td style="text-align: center;">0.18379</td>
<td style="text-align: center;">0.04777</td>
<td style="text-align: center;">-0.91775</td>
<td style="text-align: center;">-0.95787</td>
<td style="text-align: center;">-2.13689</td>
<td style="text-align: center;">0.04327</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>The model is trained on the entire training dataset and subsequently tested on the untouched test dataset, ensuring that the parameter calibration process remains independent from the test data.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>mean <span class="ot">&lt;-</span> <span class="fu">sum</span>(train2<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">sum</span>(train2<span class="sc">$</span>expo) </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>test2<span class="sc">$</span>pred.base <span class="ot">&lt;-</span> mean<span class="sc">*</span>test2<span class="sc">$</span>expo</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">Score.pred</span>(test2<span class="sc">$</span>pred.base, test2<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">nrow</span>(test2)))</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="st">'Base'</span>, Result_)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>Result_all <span class="ot">&lt;-</span> Result_</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Result_all, <span class="at">align =</span> <span class="st">"ccccccc"</span>, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>), <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>))<span class="sc">%&gt;%</span>   </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> T)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-Pscore_basetest" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.2: Prediction scores for the base model (testing set)</caption>
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.log</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.MSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.quad</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.sph</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.DSS</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.CRPS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Base</td>
<td style="text-align: center;">0.17674</td>
<td style="text-align: center;">0.04545</td>
<td style="text-align: center;">-0.92147</td>
<td style="text-align: center;">-0.95981</td>
<td style="text-align: center;">-2.19876</td>
<td style="text-align: center;">0.04127</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<p>For comparison, we start with a simple GLM model considering only the traditional covariates (excluding the protected variables). Therefore, we include:</p>
<ul>
<li>Car.use,<br>
</li>
<li>Region,<br>
</li>
<li>Car.age,</li>
<li>Years.noclaims.</li>
</ul>
<p>The model’s prediction scores are displayed below. As expected, adding segmentation variables improves the prediction scores compared to the simple baseline model with only an intercept.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Model </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>score.base <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo)))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>score.glm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo)))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Model on each fold</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>Result_  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>Result2_  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb.fold) {</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    learn <span class="ot">&lt;-</span> train2[train2<span class="sc">$</span>fold <span class="sc">!=</span> i,]</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    valid <span class="ot">&lt;-</span> train2[train2<span class="sc">$</span>fold <span class="sc">==</span> i,]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> learn)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    learn<span class="sc">$</span>pred.base <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>learn, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    valid<span class="sc">$</span>pred.base <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>valid, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    Result_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_, <span class="fu">c</span>(i, <span class="fu">Score.pred</span>(valid<span class="sc">$</span>pred.base, valid<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">nrow</span>(valid)))</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    Result2_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result2_, <span class="fu">c</span>(i, <span class="fu">Score.pred</span>(valid<span class="sc">$</span>pred.base, valid<span class="sc">$</span>NB_Claim)))</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Model on all data from train</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>glm.base <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.base, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>train2<span class="sc">$</span>pred.glm1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>train2, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>Result.glm1 <span class="ot">&lt;-</span> Result_  </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="do">## Show results</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Fold'</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result2_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Fold'</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>tot <span class="ot">&lt;-</span> <span class="fu">colSums</span>(Result2_)<span class="sc">/</span><span class="fu">nrow</span>(train2)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>tot<span class="sc">$</span>Fold <span class="ot">&lt;-</span> <span class="st">'Total'</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_ , tot)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_, Base)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>Result_[nb.fold<span class="sc">+</span><span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">'Improvement'</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>){</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  Result_[nb.fold<span class="sc">+</span><span class="dv">2</span>,i] <span class="ot">&lt;-</span>  Result_[nb.fold<span class="sc">+</span><span class="dv">1</span>,i] <span class="sc">-</span> Result_[nb.fold<span class="sc">+</span><span class="dv">2</span>,i]</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(Result_) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Result_, <span class="at">align =</span> <span class="st">"ccccccc"</span>, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>), <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>))<span class="sc">%&gt;%</span>   </span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> T)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-TeleGLM2" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.3: Prediction scores for the GLM model with traditional covariates (without protected)</caption>
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Fold</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.log</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.MSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.quad</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.sph</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.DSS</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.CRPS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.17859</td>
<td style="text-align: center;">0.04632</td>
<td style="text-align: center;">-0.91850</td>
<td style="text-align: center;">-0.95813</td>
<td style="text-align: center;">-2.26779</td>
<td style="text-align: center;">0.04253</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">0.17983</td>
<td style="text-align: center;">0.04658</td>
<td style="text-align: center;">-0.91905</td>
<td style="text-align: center;">-0.95848</td>
<td style="text-align: center;">-2.12885</td>
<td style="text-align: center;">0.04243</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.17133</td>
<td style="text-align: center;">0.04523</td>
<td style="text-align: center;">-0.92405</td>
<td style="text-align: center;">-0.96107</td>
<td style="text-align: center;">-2.30038</td>
<td style="text-align: center;">0.04031</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">0.19041</td>
<td style="text-align: center;">0.05106</td>
<td style="text-align: center;">-0.91249</td>
<td style="text-align: center;">-0.95493</td>
<td style="text-align: center;">-2.15895</td>
<td style="text-align: center;">0.04611</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.18255</td>
<td style="text-align: center;">0.04803</td>
<td style="text-align: center;">-0.91717</td>
<td style="text-align: center;">-0.95744</td>
<td style="text-align: center;">-2.22301</td>
<td style="text-align: center;">0.04358</td>
</tr>
<tr class="even">
<td style="text-align: center;">Total</td>
<td style="text-align: center;">0.18054</td>
<td style="text-align: center;">0.04744</td>
<td style="text-align: center;">-0.91826</td>
<td style="text-align: center;">-0.95801</td>
<td style="text-align: center;">-2.21586</td>
<td style="text-align: center;">0.04299</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Improvement</td>
<td style="text-align: center;">-0.00326</td>
<td style="text-align: center;">-0.00032</td>
<td style="text-align: center;">-0.00051</td>
<td style="text-align: center;">-0.00014</td>
<td style="text-align: center;">-0.07896</td>
<td style="text-align: center;">-0.00028</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>The comparison with the test dataset is also depicted in the table below.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>score.glm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo)))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>test2<span class="sc">$</span>pred.base <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>test2, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">Score.pred</span>(test2<span class="sc">$</span>pred.base, test2<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">nrow</span>(test2)))</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="st">'GLM (trad.)'</span>, Result_)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>Result_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_all, Result_)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Result_all, <span class="at">align =</span> <span class="st">"ccccccc"</span>, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>), <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>))<span class="sc">%&gt;%</span>   </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> T)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-Pscore_basetest2" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.4: Prediction scores for the GLM model with traditional covariates (testing set)</caption>
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.log</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.MSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.quad</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.sph</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.DSS</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.CRPS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Base</td>
<td style="text-align: center;">0.17674</td>
<td style="text-align: center;">0.04545</td>
<td style="text-align: center;">-0.92147</td>
<td style="text-align: center;">-0.95981</td>
<td style="text-align: center;">-2.19876</td>
<td style="text-align: center;">0.04127</td>
</tr>
<tr class="even">
<td style="text-align: center;">GLM (trad.)</td>
<td style="text-align: center;">0.17359</td>
<td style="text-align: center;">0.04514</td>
<td style="text-align: center;">-0.92197</td>
<td style="text-align: center;">-0.95995</td>
<td style="text-align: center;">-2.27716</td>
<td style="text-align: center;">0.04099</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<p>The table below shows the estimators obtained for the GLM-Poisson approach and compares them with the baseline model, which has only an intercept.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Model </span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>score.base <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo)))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>score.glm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo)))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Model on all data from train</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>glm.base <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.base, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="fu">tab_model</span>(glm.base, glm.fit, <span class="at">transform =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-TeleGLM1" class="anchored">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Table&nbsp;4.5: Estimated parameters for the GLM model with traditional covariates (without protected)</caption>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" style="text-align: center; border-top: double; font-style: normal; font-weight: bold; padding: 0.2cm;">&nbsp;</td>
<td colspan="3" data-quarto-table-cell-role="th" style="text-align: center; border-top: double; font-style: normal; font-weight: bold; padding: 0.2cm;">NB Claim</td>
<td colspan="3" data-quarto-table-cell-role="th" style="text-align: center; border-top: double; font-style: normal; font-weight: bold; padding: 0.2cm;">NB Claim</td>
</tr>
<tr class="even">
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">Predictors</td>
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">Log-Mean</td>
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">CI</td>
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">p</td>
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">Log-Mean</td>
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">CI</td>
<td style="text-align: center;">p</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">(Intercept)</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-2.94</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-2.98&nbsp;–&nbsp;-2.91</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"><strong>&lt;0.001</strong></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-1.78</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-2.00&nbsp;–&nbsp;-1.56</td>
<td style="text-align: center;"><strong>&lt;0.001</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">Car use [Commute]</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.32</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.47&nbsp;–&nbsp;-0.15</td>
<td style="text-align: center;"><strong>&lt;0.001</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">Car use [Farmer]</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.84</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-1.37&nbsp;–&nbsp;-0.38</td>
<td style="text-align: center;"><strong>0.001</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">Car use [Private]</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.46</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.62&nbsp;–&nbsp;-0.29</td>
<td style="text-align: center;"><strong>&lt;0.001</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">Region [Urban]</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.14</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.05&nbsp;–&nbsp;0.22</td>
<td style="text-align: center;"><strong>0.002</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">Car age</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.03</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.05&nbsp;–&nbsp;-0.00</td>
<td style="text-align: center;"><strong>0.028</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">Car age^2</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.00</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.01&nbsp;–&nbsp;-0.00</td>
<td style="text-align: center;"><strong>0.001</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">Years noclaims</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.07</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.09&nbsp;–&nbsp;-0.05</td>
<td style="text-align: center;"><strong>&lt;0.001</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">Years noclaims^2</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.00</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.00&nbsp;–&nbsp;0.00</td>
<td style="text-align: center;"><strong>&lt;0.001</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">Years noclaims^3</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"></td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.00</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.00&nbsp;–&nbsp;-0.00</td>
<td style="text-align: center;"><strong>&lt;0.001</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm; border-top: 1px solid;">Observations</td>
<td colspan="3" style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm; border-top: 1px solid;">80000</td>
<td colspan="3" style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm; border-top: 1px solid;">80000</td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm;">R<sup>2</sup> Nagelkerke</td>
<td colspan="3" style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm;">0.000</td>
<td colspan="3" style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm;">0.028</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</div>
</div>
</div>
</section>
<section id="glm-net" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="glm-net"><span class="header-section-number">4.3</span> GLM-Net</h2>
<section id="parametric-transformation-of-continuous-covariates" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="parametric-transformation-of-continuous-covariates"><span class="header-section-number">4.3.1</span> Parametric transformation of continuous covariates</h3>
<p>Now, we add all available telematic variables to the model. Similar to the approach taken in the previous chapter, we will introduce a method utilizing the Generalized Additive Models (GAM) theory for all these continuous variables. This will enable us to observe the general form of the covariate to explain the number of claims. Subsequently, a parametric form will be proposed to achieve the best possible correspondence with the spline obtained by the GAM.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">VEHICLE USAGE LEVEL</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Type of Vehicle Usage</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false">Driving Behavior</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<p>For the two covariates related to usage level, the proposed parametric forms are as follows:</p>
<p><span class="math display">\[\begin{align*}
s(Miles.per.day) &amp;\approx Miles.per.day + log(Miles.per.day)\\
s(Avgdays.week) &amp;\approx Avgdays.week + Avgdays.week^2
\end{align*}\]</span></p>
<p>The graphs below compare the fit of the parametric approach with that of the GAM model.</p>
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>min_ <span class="ot">&lt;-</span> <span class="fu">min</span>(train2<span class="sc">$</span>Miles.per.day) </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>max_ <span class="ot">&lt;-</span> <span class="fu">max</span>(train2<span class="sc">$</span>Miles.per.day) </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>by_ <span class="ot">&lt;-</span>  (max_ <span class="sc">-</span> min_)<span class="sc">/</span>(<span class="fu">nrow</span>(train2)<span class="sc">-</span><span class="dv">1</span>) </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>add <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">seq</span>(min_, max_, by_)) </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(add) <span class="ot">&lt;-</span> <span class="st">'Miles.per.day'</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>q99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(train2<span class="sc">$</span>Miles.per.day, <span class="fl">0.99</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">'Miles.per.day'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">replicate</span>(<span class="fu">nrow</span>(train2), db, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">cbind</span>(db, add)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>score.gam <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> <span class="fu">s</span>(Miles.per.day))</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>score.glm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Miles.per.day <span class="sc">+</span> <span class="fu">log</span>(Miles.per.day) )</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>gam.fit <span class="ot">&lt;-</span> <span class="fu">gam</span>(score.gam, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>base <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">abs</span>(Miles.per.day <span class="sc">-</span> <span class="fu">mean</span>(train2<span class="sc">$</span>Miles.per.day))) <span class="sc">%&gt;%</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(diff <span class="sc">==</span> <span class="fu">min</span>(diff))</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.gam<span class="sc">/</span>base<span class="sc">$</span>pred.gam[<span class="dv">1</span>]</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.glm<span class="sc">/</span>base<span class="sc">$</span>pred.glm[<span class="dv">1</span>]</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>Miles.per.day, <span class="at">y=</span>pred.gam, <span class="at">color=</span><span class="st">'GAM'</span>), <span class="at">data=</span>db) <span class="sc">+</span> </span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>Miles.per.day, <span class="at">y=</span>pred.glm, <span class="at">color=</span><span class="st">'Parametric GLM'</span>), <span class="at">data=</span>db) <span class="sc">+</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Miles per day'</span>,</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, q99) <span class="sc">+</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="do">### Avgdays.week</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>min_ <span class="ot">&lt;-</span> <span class="fu">min</span>(train2<span class="sc">$</span>Avgdays.week) </span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>max_ <span class="ot">&lt;-</span> <span class="fu">max</span>(train2<span class="sc">$</span>Avgdays.week) </span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>by_ <span class="ot">&lt;-</span>  (max_ <span class="sc">-</span> min_)<span class="sc">/</span>(<span class="fu">nrow</span>(train2)<span class="sc">-</span><span class="dv">1</span>) </span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>add <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">seq</span>(min_, max_, by_)) </span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(add) <span class="ot">&lt;-</span> <span class="st">'Avgdays.week'</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>q99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(train2<span class="sc">$</span>Avgdays.week, <span class="fl">0.99</span>)</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">'Avgdays.week'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) </span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">replicate</span>(<span class="fu">nrow</span>(train2), db, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">cbind</span>(db, add)</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>score.gam <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> <span class="fu">s</span>(Avgdays.week))</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>score.glm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Avgdays.week <span class="sc">+</span> <span class="fu">I</span>(Avgdays.week<span class="sc">^</span><span class="dv">2</span>) )</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>gam.fit <span class="ot">&lt;-</span> <span class="fu">gam</span>(score.gam, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>base <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">abs</span>(Avgdays.week <span class="sc">-</span> <span class="fu">mean</span>(train2<span class="sc">$</span>Avgdays.week))) <span class="sc">%&gt;%</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(diff <span class="sc">==</span> <span class="fu">min</span>(diff))</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.gam<span class="sc">/</span>base<span class="sc">$</span>pred.gam[<span class="dv">1</span>]</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.glm<span class="sc">/</span>base<span class="sc">$</span>pred.glm[<span class="dv">1</span>]</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>Avgdays.week, <span class="at">y=</span>pred.gam, <span class="at">color=</span><span class="st">'GAM'</span>), <span class="at">data=</span>db) <span class="sc">+</span> </span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>Avgdays.week, <span class="at">y=</span>pred.glm, <span class="at">color=</span><span class="st">'Parametric GLM'</span>), <span class="at">data=</span>db) <span class="sc">+</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Avgdays.week'</span>,</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, q99) <span class="sc">+</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-MpD_GAM_sev_tel" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-MpD_GAM_sev_tel-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-MpD_GAM_sev_tel-1.png" class="img-fluid figure-img" data-ref-parent="fig-MpD_GAM_sev_tel" width="672"></p>
<figcaption class="figure-caption">(a) Miles.per.day</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-MpD_GAM_sev_tel-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-MpD_GAM_sev_tel-2.png" class="img-fluid figure-img" data-ref-parent="fig-MpD_GAM_sev_tel" width="672"></p>
<figcaption class="figure-caption">(b) Avgdays.week</figcaption>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;4.1: Smoothing of Usage level covariates</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<p>Several covariates are available in the category <em>Type of vehicle usage</em>:</p>
<ul>
<li>We propose the same parametric form for all variants of the variable <em>Pct.drive.day</em> (Monday to Sunday);<br>
</li>
<li>The same parametric form will also be proposed for <em>Pct.drive.rush.am</em>, <em>Pct.drive.rush.pm</em>, <em>Pct.drive.2hrs</em>, <em>Pct.drive.3hrs</em>, and <em>Pct.drive.4hrs</em>;<br>
</li>
<li>The other three covariates have their own parametric form.</li>
</ul>
<p>We then have:</p>
<p><span class="math display">\[\begin{align*}
s(Pct.drive.day) &amp;\approx Pct.drive.day + Pct.drive.day^2 \\
s(Pct.drive) &amp;\approx Pct.drive + \sqrt{Pct.drive} \\
s(max.day) &amp;\approx max.day + \log(max.day) \\
s(min.day) &amp;\approx min.day + min.day^2 \\
s(max.min) &amp;\approx max.min + max.min^2
\end{align*}\]</span></p>
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>train2<span class="sc">$</span>Pct.drive <span class="ot">&lt;-</span> train2<span class="sc">$</span>Pct.drive.sun</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>min_ <span class="ot">&lt;-</span> <span class="fu">min</span>(train2<span class="sc">$</span>Pct.drive) </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>max_ <span class="ot">&lt;-</span> <span class="fu">max</span>(train2<span class="sc">$</span>Pct.drive) </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>by_ <span class="ot">&lt;-</span>  (max_ <span class="sc">-</span> min_)<span class="sc">/</span>(<span class="fu">nrow</span>(train2)<span class="sc">-</span><span class="dv">1</span>) </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>add <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">seq</span>(min_, max_, by_)) </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(add) <span class="ot">&lt;-</span> <span class="st">'Pct.drive'</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>q99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(train2<span class="sc">$</span>Pct.drive, <span class="fl">0.99</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">'Pct.drive'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">replicate</span>(<span class="fu">nrow</span>(train2), db, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">cbind</span>(db, add)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>score.gam <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> <span class="fu">s</span>(Pct.drive))</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>score.glm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive <span class="sc">+</span> <span class="fu">I</span>(Pct.drive<span class="sc">^</span><span class="dv">2</span>) )</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>gam.fit <span class="ot">&lt;-</span> <span class="fu">gam</span>(score.gam, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>base <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">abs</span>(Pct.drive <span class="sc">-</span> <span class="fu">mean</span>(train2<span class="sc">$</span>Pct.drive))) <span class="sc">%&gt;%</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(diff <span class="sc">==</span> <span class="fu">min</span>(diff))</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.gam<span class="sc">/</span>base<span class="sc">$</span>pred.gam[<span class="dv">1</span>]</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.glm<span class="sc">/</span>base<span class="sc">$</span>pred.glm[<span class="dv">1</span>]</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>Pct.drive, <span class="at">y=</span>pred.gam, <span class="at">color=</span><span class="st">'GAM'</span>), <span class="at">data=</span>db) <span class="sc">+</span> </span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>Pct.drive, <span class="at">y=</span>pred.glm, <span class="at">color=</span><span class="st">'Parametric GLM'</span>), <span class="at">data=</span>db) <span class="sc">+</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Pct.drive'</span>,</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, q99) <span class="sc">+</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="do">### Pct.drive </span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>train2<span class="sc">$</span>use.day <span class="ot">&lt;-</span> train2<span class="sc">$</span>Pct.drive.rush.am</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>min_ <span class="ot">&lt;-</span> <span class="fu">min</span>(train2<span class="sc">$</span>use.day) </span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>max_ <span class="ot">&lt;-</span> <span class="fu">max</span>(train2<span class="sc">$</span>use.day) </span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>by_ <span class="ot">&lt;-</span>  (max_ <span class="sc">-</span> min_)<span class="sc">/</span>(<span class="fu">nrow</span>(train2)<span class="sc">-</span><span class="dv">1</span>) </span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>add <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">seq</span>(min_, max_, by_)) </span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(add) <span class="ot">&lt;-</span> <span class="st">'use.day'</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>q99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(train2<span class="sc">$</span>use.day, <span class="fl">0.99</span>)</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">'use.day'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) </span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">replicate</span>(<span class="fu">nrow</span>(train2), db, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">cbind</span>(db, add)</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>score.gam <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> <span class="fu">s</span>(use.day))</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>score.glm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> use.day <span class="sc">+</span> <span class="fu">I</span>(use.day<span class="sc">^</span><span class="fl">0.5</span>))</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>gam.fit <span class="ot">&lt;-</span> <span class="fu">gam</span>(score.gam, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>base <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">abs</span>(use.day <span class="sc">-</span> <span class="fu">mean</span>(train2<span class="sc">$</span>use.day))) <span class="sc">%&gt;%</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(diff <span class="sc">==</span> <span class="fu">min</span>(diff))</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.gam<span class="sc">/</span>base<span class="sc">$</span>pred.gam[<span class="dv">1</span>]</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.glm<span class="sc">/</span>base<span class="sc">$</span>pred.glm[<span class="dv">1</span>]</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>use.day, <span class="at">y=</span>pred.gam, <span class="at">color=</span><span class="st">'GAM'</span>), <span class="at">data=</span>db) <span class="sc">+</span> </span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>use.day, <span class="at">y=</span>pred.glm, <span class="at">color=</span><span class="st">'Parametric GLM'</span>), <span class="at">data=</span>db) <span class="sc">+</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Use per day'</span>,</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, q99) <span class="sc">+</span></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a><span class="do">### Max day</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>train2<span class="sc">$</span>use.day <span class="ot">&lt;-</span> train2<span class="sc">$</span>max.day</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>min_ <span class="ot">&lt;-</span> <span class="fu">min</span>(train2<span class="sc">$</span>use.day) </span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>max_ <span class="ot">&lt;-</span> <span class="fu">max</span>(train2<span class="sc">$</span>use.day) </span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>by_ <span class="ot">&lt;-</span>  (max_ <span class="sc">-</span> min_)<span class="sc">/</span>(<span class="fu">nrow</span>(train2)<span class="sc">-</span><span class="dv">1</span>) </span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>add <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">seq</span>(min_, max_, by_)) </span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(add) <span class="ot">&lt;-</span> <span class="st">'use.day'</span></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>q99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(train2<span class="sc">$</span>use.day, <span class="fl">0.99</span>)</span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">'use.day'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) </span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">replicate</span>(<span class="fu">nrow</span>(train2), db, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">cbind</span>(db, add)</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>score.gam <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> <span class="fu">s</span>(use.day))</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>score.glm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> use.day <span class="sc">+</span> <span class="fu">log</span>(use.day) )</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>gam.fit <span class="ot">&lt;-</span> <span class="fu">gam</span>(score.gam, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>base <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span></span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">abs</span>(use.day <span class="sc">-</span> <span class="fu">mean</span>(train2<span class="sc">$</span>use.day))) <span class="sc">%&gt;%</span></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(diff <span class="sc">==</span> <span class="fu">min</span>(diff))</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.gam<span class="sc">/</span>base<span class="sc">$</span>pred.gam[<span class="dv">1</span>]</span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.glm<span class="sc">/</span>base<span class="sc">$</span>pred.glm[<span class="dv">1</span>]</span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>use.day, <span class="at">y=</span>pred.gam, <span class="at">color=</span><span class="st">'GAM'</span>), <span class="at">data=</span>db) <span class="sc">+</span> </span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>use.day, <span class="at">y=</span>pred.glm, <span class="at">color=</span><span class="st">'Parametric GLM'</span>), <span class="at">data=</span>db) <span class="sc">+</span></span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Use per day'</span>,</span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, q99) <span class="sc">+</span></span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a><span class="do">### Min day</span></span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>train2<span class="sc">$</span>use.day <span class="ot">&lt;-</span> train2<span class="sc">$</span>min.day</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>min_ <span class="ot">&lt;-</span> <span class="fu">min</span>(train2<span class="sc">$</span>use.day) </span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>max_ <span class="ot">&lt;-</span> <span class="fu">max</span>(train2<span class="sc">$</span>use.day) </span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>by_ <span class="ot">&lt;-</span>  (max_ <span class="sc">-</span> min_)<span class="sc">/</span>(<span class="fu">nrow</span>(train2)<span class="sc">-</span><span class="dv">1</span>) </span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>add <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">seq</span>(min_, max_, by_)) </span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(add) <span class="ot">&lt;-</span> <span class="st">'use.day'</span></span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>q99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(train2<span class="sc">$</span>use.day, <span class="fl">0.99</span>)</span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">'use.day'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) </span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">replicate</span>(<span class="fu">nrow</span>(train2), db, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">cbind</span>(db, add)</span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>score.gam <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> <span class="fu">s</span>(use.day))</span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>score.glm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> use.day <span class="sc">+</span> <span class="fu">I</span>(use.day<span class="sc">^</span><span class="dv">2</span>) )</span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>gam.fit <span class="ot">&lt;-</span> <span class="fu">gam</span>(score.gam, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a>base <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span></span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">abs</span>(use.day <span class="sc">-</span> <span class="fu">mean</span>(train2<span class="sc">$</span>use.day))) <span class="sc">%&gt;%</span></span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(diff <span class="sc">==</span> <span class="fu">min</span>(diff))</span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.gam<span class="sc">/</span>base<span class="sc">$</span>pred.gam[<span class="dv">1</span>]</span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.glm<span class="sc">/</span>base<span class="sc">$</span>pred.glm[<span class="dv">1</span>]</span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>use.day, <span class="at">y=</span>pred.gam, <span class="at">color=</span><span class="st">'GAM'</span>), <span class="at">data=</span>db) <span class="sc">+</span> </span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>use.day, <span class="at">y=</span>pred.glm, <span class="at">color=</span><span class="st">'Parametric GLM'</span>), <span class="at">data=</span>db) <span class="sc">+</span></span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Use per day'</span>,</span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, q99) <span class="sc">+</span></span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a><span class="do">### Max min</span></span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a>train2<span class="sc">$</span>use.day <span class="ot">&lt;-</span> train2<span class="sc">$</span>max.min</span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>min_ <span class="ot">&lt;-</span> <span class="fu">min</span>(train2<span class="sc">$</span>use.day) </span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a>max_ <span class="ot">&lt;-</span> <span class="fu">max</span>(train2<span class="sc">$</span>use.day) </span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a>by_ <span class="ot">&lt;-</span>  (max_ <span class="sc">-</span> min_)<span class="sc">/</span>(<span class="fu">nrow</span>(train2)<span class="sc">-</span><span class="dv">1</span>) </span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a>add <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">seq</span>(min_, max_, by_)) </span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(add) <span class="ot">&lt;-</span> <span class="st">'use.day'</span></span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a>q99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(train2<span class="sc">$</span>use.day, <span class="fl">0.99</span>)</span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">'use.day'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) </span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">replicate</span>(<span class="fu">nrow</span>(train2), db, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">cbind</span>(db, add)</span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a>score.gam <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> <span class="fu">s</span>(use.day))</span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a>score.glm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> use.day <span class="sc">+</span> <span class="fu">I</span>(use.day<span class="sc">^</span><span class="dv">2</span>) )</span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a>gam.fit <span class="ot">&lt;-</span> <span class="fu">gam</span>(score.gam, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a>glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a>base <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span></span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">abs</span>(use.day <span class="sc">-</span> <span class="fu">mean</span>(train2<span class="sc">$</span>use.day))) <span class="sc">%&gt;%</span></span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(diff <span class="sc">==</span> <span class="fu">min</span>(diff))</span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.gam<span class="sc">/</span>base<span class="sc">$</span>pred.gam[<span class="dv">1</span>]</span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.glm<span class="sc">/</span>base<span class="sc">$</span>pred.glm[<span class="dv">1</span>]</span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>use.day, <span class="at">y=</span>pred.gam, <span class="at">color=</span><span class="st">'GAM'</span>), <span class="at">data=</span>db) <span class="sc">+</span> </span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>use.day, <span class="at">y=</span>pred.glm, <span class="at">color=</span><span class="st">'Parametric GLM'</span>), <span class="at">data=</span>db) <span class="sc">+</span></span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Use per day'</span>,</span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, q99) <span class="sc">+</span></span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-MpD_GAM_sev_tel3" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-MpD_GAM_sev_tel3-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-MpD_GAM_sev_tel3-1.png" class="img-fluid figure-img" data-ref-parent="fig-MpD_GAM_sev_tel3" width="672"></p>
<figcaption class="figure-caption">(a) Pct.drive.mon</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-MpD_GAM_sev_tel3-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-MpD_GAM_sev_tel3-2.png" class="img-fluid figure-img" data-ref-parent="fig-MpD_GAM_sev_tel3" width="672"></p>
<figcaption class="figure-caption">(b) Pct.drive.rush.am</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-MpD_GAM_sev_tel3-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-MpD_GAM_sev_tel3-3.png" class="img-fluid figure-img" data-ref-parent="fig-MpD_GAM_sev_tel3" width="672"></p>
<figcaption class="figure-caption">(c) max.day</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-MpD_GAM_sev_tel3-4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-MpD_GAM_sev_tel3-4.png" class="img-fluid figure-img" data-ref-parent="fig-MpD_GAM_sev_tel3" width="672"></p>
<figcaption class="figure-caption">(d) min.day</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-MpD_GAM_sev_tel3-5" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-MpD_GAM_sev_tel3-5.png" class="img-fluid figure-img" data-ref-parent="fig-MpD_GAM_sev_tel3" width="672"></p>
<figcaption class="figure-caption">(e) max.min</figcaption>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;4.2: Smoothing of Type of vehicle usage covariates (severity)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<p>The same parametric form is proposed for the different variants of the <em>Accel</em> and <em>Brake</em> variables, i.e., <em>Accel.06miles</em> to <em>Accel.14miles</em>, and <em>Brake.06miles</em> to <em>Brake.14miles</em>. For the different variants of the <em>turn</em> variable, a single parametric form is also used:</p>
<p><span class="math display">\[\begin{align*}
s(Brake.Accel) &amp;\approx Brake.Accel + Brake.Accel^2 + Brake.Accel^3\\
s(Turn) &amp;\approx Turn + log(Turn)
\end{align*}\]</span></p>
<p>The graphs below compare the fit of the parametric approach for <em>Accel.06miles</em> and <em>Right.turn.intensity08</em> with that of the GAM model.</p>
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>train2<span class="sc">$</span>use.day <span class="ot">&lt;-</span> train2<span class="sc">$</span>Accel<span class="fl">.06</span>miles</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>min_ <span class="ot">&lt;-</span> <span class="fu">min</span>(train2<span class="sc">$</span>use.day) </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>max_ <span class="ot">&lt;-</span> <span class="fu">max</span>(train2<span class="sc">$</span>use.day) </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>by_ <span class="ot">&lt;-</span>  (max_ <span class="sc">-</span> min_)<span class="sc">/</span>(<span class="fu">nrow</span>(train2)<span class="sc">-</span><span class="dv">1</span>) </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>add <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">seq</span>(min_, max_, by_)) </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(add) <span class="ot">&lt;-</span> <span class="st">'use.day'</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>q99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(train2<span class="sc">$</span>use.day, <span class="fl">0.99</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">'use.day'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">replicate</span>(<span class="fu">nrow</span>(train2), db, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">cbind</span>(db, add)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>score.gam <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> <span class="fu">s</span>(use.day))</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>score.glm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> use.day <span class="sc">+</span> <span class="fu">I</span>(use.day<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(use.day<span class="sc">^</span><span class="dv">3</span>) )</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>gam.fit <span class="ot">&lt;-</span> <span class="fu">gam</span>(score.gam, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> train2)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>base <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">abs</span>(use.day <span class="sc">-</span> <span class="fu">mean</span>(train2<span class="sc">$</span>use.day))) <span class="sc">%&gt;%</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(diff <span class="sc">==</span> <span class="fu">min</span>(diff))</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.gam<span class="sc">/</span>base<span class="sc">$</span>pred.gam[<span class="dv">1</span>]</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.glm<span class="sc">/</span>base<span class="sc">$</span>pred.glm[<span class="dv">1</span>]</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>use.day, <span class="at">y=</span>pred.gam, <span class="at">color=</span><span class="st">'GAM'</span>), <span class="at">data=</span>db) <span class="sc">+</span> </span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>use.day, <span class="at">y=</span>pred.glm, <span class="at">color=</span><span class="st">'Parametric GLM'</span>), <span class="at">data=</span>db) <span class="sc">+</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Use per day'</span>,</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, q99) <span class="sc">+</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="do">### Right and left turns</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>train2<span class="sc">$</span>use.day <span class="ot">&lt;-</span> train2<span class="sc">$</span>Right.turn.intensity08</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>q99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(train2<span class="sc">$</span>use.day, <span class="fl">0.99</span>)</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>min_ <span class="ot">&lt;-</span> <span class="fu">min</span>(train2<span class="sc">$</span>use.day) </span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>max_ <span class="ot">&lt;-</span> q99</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>by_ <span class="ot">&lt;-</span>  (max_ <span class="sc">-</span> min_)<span class="sc">/</span>(<span class="fu">nrow</span>(train2)<span class="sc">-</span><span class="dv">1</span>) </span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>add <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">seq</span>(min_, max_, by_)) </span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(add) <span class="ot">&lt;-</span> <span class="st">'use.day'</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">'use.day'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) </span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">replicate</span>(<span class="fu">nrow</span>(train2), db, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">cbind</span>(db, add)</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">use.day =</span> <span class="fu">pmin</span>(q99, use.day))</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>score.gam <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> <span class="fu">s</span>(use.day))</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>score.glm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(expo))</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">+</span> use.day <span class="sc">+</span> <span class="fu">log1p</span>(use.day))</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>gam.fit <span class="ot">&lt;-</span> <span class="fu">gam</span>(score.gam, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> temp)</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>glm.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(score.glm, <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> temp)</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm.fit, <span class="at">newdata=</span>db, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>base <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="fu">abs</span>(use.day <span class="sc">-</span> <span class="fu">mean</span>(temp<span class="sc">$</span>use.day))) <span class="sc">%&gt;%</span></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(diff <span class="sc">==</span> <span class="fu">min</span>(diff))</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.gam <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.gam<span class="sc">/</span>base<span class="sc">$</span>pred.gam[<span class="dv">1</span>]</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>pred.glm <span class="ot">&lt;-</span> db<span class="sc">$</span>pred.glm<span class="sc">/</span>base<span class="sc">$</span>pred.glm[<span class="dv">1</span>]</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>use.day, <span class="at">y=</span>pred.gam, <span class="at">color=</span><span class="st">'GAM'</span>), <span class="at">data=</span>db) <span class="sc">+</span> </span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>use.day, <span class="at">y=</span>pred.glm, <span class="at">color=</span><span class="st">'Parametric GLM'</span>), <span class="at">data=</span>db) <span class="sc">+</span></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Use per day'</span>,</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a> <span class="co"># xlim(0, q99) +</span></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-MpD_GAM_sev_tel2" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-MpD_GAM_sev_tel2-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-MpD_GAM_sev_tel2-1.png" class="img-fluid figure-img" data-ref-parent="fig-MpD_GAM_sev_tel2" width="672"></p>
<figcaption class="figure-caption">(a) Accel.06miles</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-MpD_GAM_sev_tel2-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-MpD_GAM_sev_tel2-2.png" class="img-fluid figure-img" data-ref-parent="fig-MpD_GAM_sev_tel2" width="672"></p>
<figcaption class="figure-caption">(b) Right.turn.intensity08</figcaption>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;4.3: Smoothing of Driving behavior covariates (severity)</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="fitting-the-glm-net-model" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="fitting-the-glm-net-model"><span class="header-section-number">4.3.2</span> Fitting the GLM-Net model</h3>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Optimal value</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">Parsimonious model</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" role="tab" aria-controls="tabset-4-3" aria-selected="false">RESIDUALS AND PROTECTED VARIABLES</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-4" role="tab" aria-controls="tabset-4-4" aria-selected="false">GLM-NET ON RESIDUALS</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<p>The parameters of the GLM-net were calibrated using cross-validation to obtain the model’s hyperparameters. Using these values, we can calculate the prediction scores of the model based on all covariates.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>glm.score <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Dayformax <span class="sc">+</span> Dayformin <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Miles.per.day <span class="sc">+</span> <span class="fu">log</span>(Miles.per.day)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Avgdays.week <span class="sc">+</span> <span class="fu">I</span>(Avgdays.week<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.mon <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.mon<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.tue <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.tue<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.wed <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.wed<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.thr <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.thr<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.fri <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.fri<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.sat <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.sat<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.sun <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.sun<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.wkend <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.wkend<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> max.day <span class="sc">+</span> <span class="fu">log</span>(max.day) </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> min.day <span class="sc">+</span> <span class="fu">I</span>(min.day<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> max.min <span class="sc">+</span> <span class="fu">I</span>(max.min<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.rush.am <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive.rush.am) </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.rush.pm <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive.rush.pm)   </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive<span class="fl">.2</span>hrs <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive<span class="fl">.2</span>hrs) </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive<span class="fl">.3</span>hrs <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive<span class="fl">.3</span>hrs) </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive<span class="fl">.4</span>hrs <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive<span class="fl">.4</span>hrs) </span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.06</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.08</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.09</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.11</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.12</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.14</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.06</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.08</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.09</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.11</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.12</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.14</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity08 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity08)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity09 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity09)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity10 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity10)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity11 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity11)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity12 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity12)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity08 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity08)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity09 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity09)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity10 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity10)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity11 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity11)</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity12 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity12))</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>Result_  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>Result2_  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb.fold) {</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    learn <span class="ot">&lt;-</span> train2[train2<span class="sc">$</span>fold <span class="sc">!=</span> i,]</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    valid <span class="ot">&lt;-</span> train2[train2<span class="sc">$</span>fold <span class="sc">==</span> i,]</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>learn)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> learn<span class="sc">$</span>NB_Claim</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    offset <span class="ot">&lt;-</span> <span class="fu">log</span>(learn<span class="sc">$</span>expo)</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    lambda.min <span class="ot">&lt;-</span> <span class="fl">3.981072e-05</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    lambda<span class="fl">.1</span>se <span class="ot">&lt;-</span> <span class="fl">0.001258925</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    lambda.select <span class="ot">&lt;-</span> lambda.min</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(matrix.x, y, <span class="at">family =</span> <span class="st">"poisson"</span>, <span class="at">relax=</span><span class="cn">FALSE</span>, <span class="at">offset =</span> offset, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">#fit &lt;- glmnet(matrix.x, y, family = "poisson", relax=TRUE, offset = offset, alpha = 1, lambda = lambda.select)</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>valid)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> valid<span class="sc">$</span>NB_Claim</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>    offset <span class="ot">&lt;-</span> <span class="fu">log</span>(valid<span class="sc">$</span>expo)</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    valid<span class="sc">$</span>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newx =</span> matrix.x, <span class="at">type=</span><span class="st">'response'</span>, <span class="at">newoffset=</span>offset, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>    Result_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_, <span class="fu">c</span>(i, <span class="fu">Score.pred</span>(valid<span class="sc">$</span>pred, valid<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">nrow</span>(valid)))</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>    Result2_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result2_, <span class="fu">c</span>(i, <span class="fu">Score.pred</span>(valid<span class="sc">$</span>pred, valid<span class="sc">$</span>NB_Claim)))</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a><span class="do">## Show results</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Fold'</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result2_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Fold'</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>tot <span class="ot">&lt;-</span> <span class="fu">colSums</span>(Result2_)<span class="sc">/</span><span class="fu">nrow</span>(train2)</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>tot<span class="sc">$</span>Fold <span class="ot">&lt;-</span> <span class="st">'Total'</span></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_ , tot)</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_, Base)</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>Result_[nb.fold<span class="sc">+</span><span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">'Improvement'</span></span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>){</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>  Result_[nb.fold<span class="sc">+</span><span class="dv">2</span>,i] <span class="ot">&lt;-</span>  Result_[nb.fold<span class="sc">+</span><span class="dv">1</span>,i] <span class="sc">-</span> Result_[nb.fold<span class="sc">+</span><span class="dv">2</span>,i]</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(Result_) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Result_, <span class="at">align =</span> <span class="st">"ccccccc"</span>, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>), <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>))<span class="sc">%&gt;%</span>   </span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> T)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-Pscore_teleGLMnet1" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.6: Prediction scores for the GLM-net model (alpha=1)</caption>
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Fold</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.log</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.MSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.quad</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.sph</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.DSS</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.CRPS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.16065</td>
<td style="text-align: center;">0.04360</td>
<td style="text-align: center;">-0.92280</td>
<td style="text-align: center;">-0.95956</td>
<td style="text-align: center;">-2.84021</td>
<td style="text-align: center;">0.04018</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">0.15958</td>
<td style="text-align: center;">0.04302</td>
<td style="text-align: center;">-0.92380</td>
<td style="text-align: center;">-0.96009</td>
<td style="text-align: center;">512.20739</td>
<td style="text-align: center;">0.03970</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.15391</td>
<td style="text-align: center;">0.04248</td>
<td style="text-align: center;">-0.92795</td>
<td style="text-align: center;">-0.96228</td>
<td style="text-align: center;">5.94017</td>
<td style="text-align: center;">0.03807</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">0.16786</td>
<td style="text-align: center;">0.04706</td>
<td style="text-align: center;">-0.91797</td>
<td style="text-align: center;">-0.95674</td>
<td style="text-align: center;">-2.67292</td>
<td style="text-align: center;">0.04298</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.16300</td>
<td style="text-align: center;">0.04500</td>
<td style="text-align: center;">-0.92166</td>
<td style="text-align: center;">-0.95890</td>
<td style="text-align: center;">-2.76580</td>
<td style="text-align: center;">0.04106</td>
</tr>
<tr class="even">
<td style="text-align: center;">Total</td>
<td style="text-align: center;">0.16099</td>
<td style="text-align: center;">0.04424</td>
<td style="text-align: center;">-0.92284</td>
<td style="text-align: center;">-0.95952</td>
<td style="text-align: center;">101.77054</td>
<td style="text-align: center;">0.04039</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Improvement</td>
<td style="text-align: center;">-0.02280</td>
<td style="text-align: center;">-0.00353</td>
<td style="text-align: center;">-0.00509</td>
<td style="text-align: center;">-0.00164</td>
<td style="text-align: center;">103.90744</td>
<td style="text-align: center;">-0.00287</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>On the <em>test</em> set, we obtain:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>glm.score <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Dayformax <span class="sc">+</span> Dayformin <span class="sc">+</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Miles.per.day <span class="sc">+</span> <span class="fu">log</span>(Miles.per.day)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Avgdays.week <span class="sc">+</span> <span class="fu">I</span>(Avgdays.week<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.mon <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.mon<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.tue <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.tue<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.wed <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.wed<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.thr <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.thr<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.fri <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.fri<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.sat <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.sat<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.sun <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.sun<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.wkend <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.wkend<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> max.day <span class="sc">+</span> <span class="fu">log</span>(max.day) </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> min.day <span class="sc">+</span> <span class="fu">I</span>(min.day<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> max.min <span class="sc">+</span> <span class="fu">I</span>(max.min<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.rush.am <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive.rush.am) </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.rush.pm <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive.rush.pm)   </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive<span class="fl">.2</span>hrs <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive<span class="fl">.2</span>hrs) </span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive<span class="fl">.3</span>hrs <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive<span class="fl">.3</span>hrs) </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive<span class="fl">.4</span>hrs <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive<span class="fl">.4</span>hrs) </span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.06</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.08</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.09</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.11</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.12</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.14</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.06</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.08</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.09</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.11</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.12</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.14</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity08 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity08)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity09 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity09)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity10 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity10)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity11 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity11)</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity12 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity12)</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity08 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity08)</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity09 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity09)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity10 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity10)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity11 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity11)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity12 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity12))</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>train2)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> train2<span class="sc">$</span>NB_Claim</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fu">log</span>(train2<span class="sc">$</span>expo)</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>lambda.min <span class="ot">&lt;-</span> <span class="fl">3.981072e-05</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>lambda<span class="fl">.1</span>se <span class="ot">&lt;-</span> <span class="fl">0.001258925</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>lambda.select <span class="ot">&lt;-</span> lambda.min</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(matrix.x, y, <span class="at">family =</span> <span class="st">"poisson"</span>, <span class="at">relax=</span><span class="cn">FALSE</span>, <span class="at">offset =</span> offset, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a><span class="co">#fit &lt;- glmnet(matrix.x, y, family = "poisson", relax=TRUE, offset = offset, alpha = 1, lambda = lambda.select)</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>train2<span class="sc">$</span>pred.tele <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newx =</span> matrix.x, <span class="at">type=</span><span class="st">'response'</span>, <span class="at">newoffset=</span>offset, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>test2)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> test2<span class="sc">$</span>NB_Claim</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fu">log</span>(test2<span class="sc">$</span>expo)</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>test2<span class="sc">$</span>pred.base <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newx =</span> matrix.x, <span class="at">type=</span><span class="st">'response'</span>, <span class="at">newoffset=</span>offset, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">Score.pred</span>(test2<span class="sc">$</span>pred.base, test2<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">nrow</span>(test2)))</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="st">'LASSO (optimal)'</span>, Result_)</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>Result_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_all, Result_)</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Result_all, <span class="at">align =</span> <span class="st">"ccccccc"</span>, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>), <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>))<span class="sc">%&gt;%</span>   </span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> T)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-Pscore_basetest3" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.7: Prediction scores for the GLM-net model (testing set)</caption>
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.log</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.MSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.quad</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.sph</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.DSS</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.CRPS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Base</td>
<td style="text-align: center;">0.17674</td>
<td style="text-align: center;">0.04545</td>
<td style="text-align: center;">-0.92147</td>
<td style="text-align: center;">-0.95981</td>
<td style="text-align: center;">-2.19876</td>
<td style="text-align: center;">0.04127</td>
</tr>
<tr class="even">
<td style="text-align: center;">GLM (trad.)</td>
<td style="text-align: center;">0.17359</td>
<td style="text-align: center;">0.04514</td>
<td style="text-align: center;">-0.92197</td>
<td style="text-align: center;">-0.95995</td>
<td style="text-align: center;">-2.27716</td>
<td style="text-align: center;">0.04099</td>
</tr>
<tr class="odd">
<td style="text-align: center;">LASSO (optimal)</td>
<td style="text-align: center;">0.15536</td>
<td style="text-align: center;">0.04239</td>
<td style="text-align: center;">-0.92624</td>
<td style="text-align: center;">-0.96135</td>
<td style="text-align: center;">-2.69596</td>
<td style="text-align: center;">0.03866</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<p>Instead of using the optimal value of the penalty <span class="math inline">\(\lambda\)</span> in the elastic-net approach, it is often advised to use a penalty value located at one standard error (<span class="math inline">\(\lambda_{1se}\)</span>). This helps to obtain a more parsimonious model. The prediction scores of such a model are displayed below.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>Result_  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>Result2_  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb.fold) {</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    learn <span class="ot">&lt;-</span> train2[train2<span class="sc">$</span>fold <span class="sc">!=</span> i,]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    valid <span class="ot">&lt;-</span> train2[train2<span class="sc">$</span>fold <span class="sc">==</span> i,]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>learn)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> learn<span class="sc">$</span>NB_Claim</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    offset <span class="ot">&lt;-</span> <span class="fu">log</span>(learn<span class="sc">$</span>expo)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    lambda.min <span class="ot">&lt;-</span> <span class="fl">3.981072e-05</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    lambda<span class="fl">.1</span>se <span class="ot">&lt;-</span> <span class="fl">0.001258925</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    lambda.select <span class="ot">&lt;-</span> lambda<span class="fl">.1</span>se</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#fit &lt;- glmnet(matrix.x, y, family = "poisson", relax=FALSE, offset = offset, alpha = 1, lambda = lambda.select)</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(matrix.x, y, <span class="at">family =</span> <span class="st">"poisson"</span>, <span class="at">relax=</span><span class="cn">TRUE</span>, <span class="at">offset =</span> offset, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>valid)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> valid<span class="sc">$</span>NB_Claim</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    offset <span class="ot">&lt;-</span> <span class="fu">log</span>(valid<span class="sc">$</span>expo)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    valid<span class="sc">$</span>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newx =</span> matrix.x, <span class="at">type=</span><span class="st">'response'</span>, <span class="at">newoffset=</span>offset, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    Result_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_, <span class="fu">c</span>(i, <span class="fu">Score.pred</span>(valid<span class="sc">$</span>pred, valid<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">nrow</span>(valid)))</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    Result2_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result2_, <span class="fu">c</span>(i, <span class="fu">Score.pred</span>(valid<span class="sc">$</span>pred, valid<span class="sc">$</span>NB_Claim)))</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="do">## Show results</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Fold'</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result2_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Fold'</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>tot <span class="ot">&lt;-</span> <span class="fu">colSums</span>(Result2_)<span class="sc">/</span><span class="fu">nrow</span>(train2)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>tot<span class="sc">$</span>Fold <span class="ot">&lt;-</span> <span class="st">'Total'</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_ , tot)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_, Base)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>Result_[nb.fold<span class="sc">+</span><span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">'Improvement'</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>){</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>  Result_[nb.fold<span class="sc">+</span><span class="dv">2</span>,i] <span class="ot">&lt;-</span>  Result_[nb.fold<span class="sc">+</span><span class="dv">1</span>,i] <span class="sc">-</span> Result_[nb.fold<span class="sc">+</span><span class="dv">2</span>,i]</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(Result_) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Result_, <span class="at">align =</span> <span class="st">"ccccccc"</span>, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>), <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>))<span class="sc">%&gt;%</span>   </span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> T)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-Pscore_GLMnet2" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.8: Prediction scores for the GLM-net model (alpha=1)</caption>
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Fold</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.log</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.MSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.quad</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.sph</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.DSS</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.CRPS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.16141</td>
<td style="text-align: center;">0.04348</td>
<td style="text-align: center;">-0.92233</td>
<td style="text-align: center;">-0.95936</td>
<td style="text-align: center;">-2.76915</td>
<td style="text-align: center;">0.04033</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">0.16045</td>
<td style="text-align: center;">0.04370</td>
<td style="text-align: center;">-0.92307</td>
<td style="text-align: center;">-0.95975</td>
<td style="text-align: center;">-2.72663</td>
<td style="text-align: center;">0.04015</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.15505</td>
<td style="text-align: center;">0.04271</td>
<td style="text-align: center;">-0.92730</td>
<td style="text-align: center;">-0.96203</td>
<td style="text-align: center;">-2.73338</td>
<td style="text-align: center;">0.03840</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">0.16975</td>
<td style="text-align: center;">0.04763</td>
<td style="text-align: center;">-0.91721</td>
<td style="text-align: center;">-0.95642</td>
<td style="text-align: center;">-2.65287</td>
<td style="text-align: center;">0.04342</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.16418</td>
<td style="text-align: center;">0.04518</td>
<td style="text-align: center;">-0.92116</td>
<td style="text-align: center;">-0.95868</td>
<td style="text-align: center;">-2.69140</td>
<td style="text-align: center;">0.04131</td>
</tr>
<tr class="even">
<td style="text-align: center;">Total</td>
<td style="text-align: center;">0.16216</td>
<td style="text-align: center;">0.04454</td>
<td style="text-align: center;">-0.92222</td>
<td style="text-align: center;">-0.95925</td>
<td style="text-align: center;">-2.71461</td>
<td style="text-align: center;">0.04072</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Improvement</td>
<td style="text-align: center;">-0.02163</td>
<td style="text-align: center;">-0.00323</td>
<td style="text-align: center;">-0.00447</td>
<td style="text-align: center;">-0.00137</td>
<td style="text-align: center;">-0.57772</td>
<td style="text-align: center;">-0.00255</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>On the <em>test</em> set, we obtain:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>glm.score <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Dayformax <span class="sc">+</span> Dayformin <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Miles.per.day <span class="sc">+</span> <span class="fu">log</span>(Miles.per.day)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Avgdays.week <span class="sc">+</span> <span class="fu">I</span>(Avgdays.week<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.mon <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.mon<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.tue <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.tue<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.wed <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.wed<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.thr <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.thr<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.fri <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.fri<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.sat <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.sat<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.sun <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.sun<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.wkend <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.wkend<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> max.day <span class="sc">+</span> <span class="fu">log</span>(max.day) </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> min.day <span class="sc">+</span> <span class="fu">I</span>(min.day<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> max.min <span class="sc">+</span> <span class="fu">I</span>(max.min<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.rush.am <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive.rush.am) </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.rush.pm <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive.rush.pm)   </span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive<span class="fl">.2</span>hrs <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive<span class="fl">.2</span>hrs) </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive<span class="fl">.3</span>hrs <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive<span class="fl">.3</span>hrs) </span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive<span class="fl">.4</span>hrs <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive<span class="fl">.4</span>hrs) </span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.06</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.08</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.09</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.11</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.12</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.14</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.06</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.08</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.09</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.11</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.12</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.14</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity08 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity08)</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity09 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity09)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity10 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity10)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity11 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity11)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity12 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity12)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity08 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity08)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity09 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity09)</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity10 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity10)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity11 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity11)</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity12 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity12))</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>train2)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> train2<span class="sc">$</span>NB_Claim</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fu">log</span>(train2<span class="sc">$</span>expo)</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>lambda.min <span class="ot">&lt;-</span> <span class="fl">3.981072e-05</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>lambda<span class="fl">.1</span>se <span class="ot">&lt;-</span> <span class="fl">0.001258925</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>lambda.select <span class="ot">&lt;-</span> lambda<span class="fl">.1</span>se</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a><span class="co">#fit &lt;- glmnet(matrix.x, y, family = "poisson", relax=FALSE, offset = offset, alpha = 1, lambda = lambda.select)</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(matrix.x, y, <span class="at">family =</span> <span class="st">"poisson"</span>, <span class="at">relax=</span><span class="cn">TRUE</span>, <span class="at">offset =</span> offset, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>test2)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> test2<span class="sc">$</span>NB_Claim</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fu">log</span>(test2<span class="sc">$</span>expo)</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>test2<span class="sc">$</span>pred.base <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newx =</span> matrix.x, <span class="at">type=</span><span class="st">'response'</span>, <span class="at">newoffset=</span>offset, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">Score.pred</span>(test2<span class="sc">$</span>pred.base, test2<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">nrow</span>(test2)))</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="st">'LASSO (parsimonious)'</span>, Result_)</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>Result_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_all, Result_)</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Result_all, <span class="at">align =</span> <span class="st">"ccccccc"</span>, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>), <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>))<span class="sc">%&gt;%</span>   </span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> T)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-Pscore_basetest4" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.9: Prediction scores for the GLM-net model (testing set)</caption>
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.log</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.MSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.quad</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.sph</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.DSS</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.CRPS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Base</td>
<td style="text-align: center;">0.17674</td>
<td style="text-align: center;">0.04545</td>
<td style="text-align: center;">-0.92147</td>
<td style="text-align: center;">-0.95981</td>
<td style="text-align: center;">-2.19876</td>
<td style="text-align: center;">0.04127</td>
</tr>
<tr class="even">
<td style="text-align: center;">GLM (trad.)</td>
<td style="text-align: center;">0.17359</td>
<td style="text-align: center;">0.04514</td>
<td style="text-align: center;">-0.92197</td>
<td style="text-align: center;">-0.95995</td>
<td style="text-align: center;">-2.27716</td>
<td style="text-align: center;">0.04099</td>
</tr>
<tr class="odd">
<td style="text-align: center;">LASSO (optimal)</td>
<td style="text-align: center;">0.15536</td>
<td style="text-align: center;">0.04239</td>
<td style="text-align: center;">-0.92624</td>
<td style="text-align: center;">-0.96135</td>
<td style="text-align: center;">-2.69596</td>
<td style="text-align: center;">0.03866</td>
</tr>
<tr class="even">
<td style="text-align: center;">LASSO (parsimonious)</td>
<td style="text-align: center;">0.15704</td>
<td style="text-align: center;">0.04261</td>
<td style="text-align: center;">-0.92579</td>
<td style="text-align: center;">-0.96120</td>
<td style="text-align: center;">-2.70016</td>
<td style="text-align: center;">0.03889</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</div>
<div id="tabset-4-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-3-tab">
<p>Comparing the results obtained with the pricing model based solely on traditional variables, we observe that the addition of telematic variables improves prediction quality. However, we can verify whether the protected variables we excluded from the analysis still retain predictive capability. Thus, we fit a GLM-net model on telematic data and predict the expected frequency of the model on the training dataset.</p>
<p>Using the prediction as an offset variable, we can effectively assess whether the protected variables still capture a trend. The reliability of this approach is further bolstered by the comparison of the results obtained with the graphs we had in Chapter 2. If a curve is horizontal and close to the value of 1 for all possible values of a covariate, it indicates that telematic variables have indeed captured the predictive capability of the variable to predict claim frequency, as demonstrated in the graphs below.</p>
<p>In the graphs below, we observe that the addition of telematic variables:</p>
<ul>
<li>diminishes the effect of credit score, but it still appears to be predictive;<br>
</li>
<li>almost eliminates the effect of driver age;<br>
</li>
<li>the addition of telematic variables has led to a significant shift in the effect of driver gender. Originally, a premium reduction for males seemed necessary, but adding telematic variables suggest that males should now have a surcharge;</li>
<li>significantly reduces the effect of marital status;<br>
</li>
<li>slightly diminishes the effect of territory without eliminating it.</li>
</ul>
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>meaninv  <span class="ot">&lt;-</span> <span class="fu">sum</span>(train2<span class="sc">$</span>expo)<span class="sc">/</span><span class="fu">sum</span>(train2<span class="sc">$</span>NB_Claim)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>temp2 <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Duration.y =</span> Duration<span class="sc">/</span><span class="fl">365.25</span>, </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">Insured.age =</span> <span class="fu">pmin</span>(Insured.age, <span class="dv">80</span>),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">Group =</span> <span class="fu">ceiling</span>(Credit.score<span class="sc">/</span><span class="dv">25</span>) <span class="sc">*</span> <span class="dv">25</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Group) <span class="sc">%&gt;%</span> </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">NB_Claim=</span><span class="fu">sum</span>(NB_Claim),</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo=</span><span class="fu">sum</span>(expo),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo2=</span><span class="fu">sum</span>(pred.tele)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">freq =</span> meaninv<span class="sc">*</span>NB_Claim<span class="sc">/</span>expo, </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq2 =</span>  NB_Claim<span class="sc">/</span>expo2)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">x=</span>Group, <span class="at">y=</span>freq, <span class="at">weight =</span> expo, <span class="at">color=</span><span class="st">'Observed'</span>),<span class="at">se=</span>F, <span class="at">size=</span><span class="dv">1</span>, <span class="at">data=</span>temp2) <span class="sc">+</span> </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">x=</span>Group, <span class="at">y=</span>freq2, <span class="at">weight =</span> expo, <span class="at">color=</span><span class="st">'Residuals'</span>),<span class="at">se=</span>F, <span class="at">size=</span><span class="dv">1</span>, <span class="at">data=</span>temp2) <span class="sc">+</span> </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Credit Score'</span>,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>)<span class="sc">+</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_classic</span>()<span class="sc">+</span>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="do">### Age of the insured</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>temp2 <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Duration.y =</span> Duration<span class="sc">/</span><span class="fl">365.25</span>, </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">Insured.age =</span> <span class="fu">pmin</span>(Insured.age, <span class="dv">80</span>),</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>                <span class="at">Group =</span> <span class="fu">ceiling</span>(Insured.age<span class="sc">/</span><span class="dv">5</span>) <span class="sc">*</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Group) <span class="sc">%&gt;%</span> </span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">NB_Claim=</span><span class="fu">sum</span>(NB_Claim),</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo=</span><span class="fu">sum</span>(expo),</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo2=</span><span class="fu">sum</span>(pred.tele)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">freq =</span> meaninv<span class="sc">*</span>NB_Claim<span class="sc">/</span>expo, </span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq2 =</span>  NB_Claim<span class="sc">/</span>expo2)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">x=</span>Group, <span class="at">y=</span>freq, <span class="at">weight =</span> expo, <span class="at">color=</span><span class="st">'Observed'</span>),<span class="at">se=</span>F, <span class="at">size=</span><span class="dv">1</span>, <span class="at">data=</span>temp2) <span class="sc">+</span> </span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">x=</span>Group, <span class="at">y=</span>freq2, <span class="at">weight =</span> expo, <span class="at">color=</span><span class="st">'Residuals'</span>),<span class="at">se=</span>F, <span class="at">size=</span><span class="dv">1</span>, <span class="at">data=</span>temp2) <span class="sc">+</span> </span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Age of the insured'</span>,</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>)<span class="sc">+</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_classic</span>()<span class="sc">+</span>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="do">### Sex of the insured</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Var_ =</span> Insured.sex) <span class="sc">%&gt;%</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Var_) <span class="sc">%&gt;%</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">nbclaim =</span> <span class="fu">sum</span>(NB_Claim),</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo =</span> <span class="fu">sum</span>(expo),</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo2 =</span> <span class="fu">sum</span>(pred.tele)) <span class="sc">%&gt;%</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">freq =</span> nbclaim<span class="sc">/</span>expo,</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq2 =</span> nbclaim<span class="sc">/</span>expo2)</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>temp<span class="sc">$</span>freq <span class="ot">&lt;-</span> temp<span class="sc">$</span>freq<span class="sc">/</span>temp<span class="sc">$</span>freq[<span class="dv">1</span>]</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>temp<span class="sc">$</span>freq2 <span class="ot">&lt;-</span> temp<span class="sc">$</span>freq2<span class="sc">/</span>temp<span class="sc">$</span>freq2[<span class="dv">1</span>]</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="co">#start plot by by plotting bars</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq2), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Residuals'</span>), <span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq2), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Residuals'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Observed'</span>), <span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Observed'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Sex of the insured'</span>, <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>)<span class="sc">+</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">max</span>(temp<span class="sc">$</span>freq, temp<span class="sc">$</span>freq2)<span class="sc">*</span><span class="fl">0.95</span>, <span class="fu">max</span>(temp<span class="sc">$</span>freq, temp<span class="sc">$</span>freq2)<span class="sc">*</span><span class="fl">1.05</span>)<span class="sc">+</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">title=</span><span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_classic</span>()<span class="sc">+</span>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a><span class="do">### Marital Status</span></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Var_ =</span> Marital) <span class="sc">%&gt;%</span></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Var_) <span class="sc">%&gt;%</span></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">nbclaim =</span> <span class="fu">sum</span>(NB_Claim),</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo =</span> <span class="fu">sum</span>(expo),</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo2 =</span> <span class="fu">sum</span>(pred.tele)) <span class="sc">%&gt;%</span></span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">freq =</span> nbclaim<span class="sc">/</span>expo, </span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq2 =</span> nbclaim<span class="sc">/</span>expo2)</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>temp<span class="sc">$</span>freq <span class="ot">&lt;-</span> temp<span class="sc">$</span>freq<span class="sc">/</span>temp<span class="sc">$</span>freq[<span class="dv">1</span>]</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>temp<span class="sc">$</span>freq2 <span class="ot">&lt;-</span> temp<span class="sc">$</span>freq2<span class="sc">/</span>temp<span class="sc">$</span>freq2[<span class="dv">1</span>]</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="co">#start plot by by plotting bars</span></span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq2), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Residuals'</span>), <span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq2), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Residuals'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Observed'</span>), <span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Observed'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Marital status of the insured'</span>, <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>)<span class="sc">+</span></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">0.9</span>, <span class="fu">max</span>(temp<span class="sc">$</span>freq, temp<span class="sc">$</span>freq2)<span class="sc">*</span><span class="fl">1.2</span>)<span class="sc">+</span></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">title=</span><span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_classic</span>()<span class="sc">+</span>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a><span class="do">### Insured's territory</span></span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Var_ =</span> Territory) <span class="sc">%&gt;%</span></span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Var_) <span class="sc">%&gt;%</span></span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">nbclaim =</span> <span class="fu">sum</span>(NB_Claim),</span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo =</span> <span class="fu">sum</span>(expo),</span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo2 =</span> <span class="fu">sum</span>(pred.tele)) <span class="sc">%&gt;%</span></span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">freq1 =</span> nbclaim<span class="sc">/</span>expo2, </span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq2 =</span> meaninv<span class="sc">*</span>nbclaim<span class="sc">/</span>expo)</span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> freq1, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Residuals'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> freq1, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Residuals'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> freq2, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Observed'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> freq2, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Observed'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>)<span class="sc">+</span></span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Territory'</span>,</span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> <span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>)<span class="sc">+</span></span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">title=</span><span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_classic</span>()<span class="sc">+</span>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-CreditScore_sev" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-CreditScore_sev-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-CreditScore_sev-1.png" class="img-fluid figure-img" data-ref-parent="fig-CreditScore_sev" width="864"></p>
<figcaption class="figure-caption">(a) Credit Score</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-CreditScore_sev-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-CreditScore_sev-2.png" class="img-fluid figure-img" data-ref-parent="fig-CreditScore_sev" width="864"></p>
<figcaption class="figure-caption">(b) Age of the Insured</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-CreditScore_sev-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-CreditScore_sev-3.png" class="img-fluid figure-img" data-ref-parent="fig-CreditScore_sev" width="864"></p>
<figcaption class="figure-caption">(c) Sex of the Insured</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-CreditScore_sev-4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-CreditScore_sev-4.png" class="img-fluid figure-img" data-ref-parent="fig-CreditScore_sev" width="864"></p>
<figcaption class="figure-caption">(d) Marital Status of the Insured</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-CreditScore_sev-5" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-CreditScore_sev-5.png" class="img-fluid figure-img" data-ref-parent="fig-CreditScore_sev" width="864"></p>
<figcaption class="figure-caption">(e) Territory</figcaption>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;4.4: Observed Relativity vs.&nbsp;Residuals Relativity</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div id="tabset-4-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-4-tab">
<p>One can directly fit a GLM-Net model by appropriately utilizing the initial predictions. By retaining only the protected variables in the GLM-Net approach while using the prediction as an offset variable, it is possible to verify whether adding protected variables enhances the model’s predictive capacity.</p>
<p>The tables below indicate the scores obtained for this new model (with the two approaches marked with an *). We observe a slight improvement in the model, indicating that using telematics data does not eliminate the need to use protected variables.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>glm.score <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Car.use <span class="sc">+</span> Region <span class="sc">+</span> Car.age <span class="sc">+</span> <span class="fu">I</span>(Car.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Years.noclaims <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(Years.noclaims<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Dayformax <span class="sc">+</span> Dayformin <span class="sc">+</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Miles.per.day <span class="sc">+</span> <span class="fu">log</span>(Miles.per.day)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Avgdays.week <span class="sc">+</span> <span class="fu">I</span>(Avgdays.week<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.mon <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.mon<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.tue <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.tue<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.wed <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.wed<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.thr <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.thr<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.fri <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.fri<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.sat <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.sat<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.sun <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.sun<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.wkend <span class="sc">+</span> <span class="fu">I</span>(Pct.drive.wkend<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> max.day <span class="sc">+</span> <span class="fu">log</span>(max.day) </span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> min.day <span class="sc">+</span> <span class="fu">I</span>(min.day<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> max.min <span class="sc">+</span> <span class="fu">I</span>(max.min<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.rush.am <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive.rush.am) </span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive.rush.pm <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive.rush.pm)   </span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive<span class="fl">.2</span>hrs <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive<span class="fl">.2</span>hrs) </span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive<span class="fl">.3</span>hrs <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive<span class="fl">.3</span>hrs) </span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Pct.drive<span class="fl">.4</span>hrs <span class="sc">+</span> <span class="fu">sqrt</span>(Pct.drive<span class="fl">.4</span>hrs) </span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.06</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.08</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.09</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.11</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.12</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Accel<span class="fl">.14</span>miles <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Accel<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.06</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.06</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.08</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.08</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.09</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.09</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.11</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.11</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.12</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.12</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Brake<span class="fl">.14</span>miles <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(Brake<span class="fl">.14</span>miles<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity08 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity08)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity09 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity09)</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity10 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity10)</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity11 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity11)</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Left.turn.intensity12 <span class="sc">+</span> <span class="fu">log1p</span>(Left.turn.intensity12)</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity08 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity08)</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity09 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity09)</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity10 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity10)</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity11 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity11)</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">+</span> Right.turn.intensity12 <span class="sc">+</span> <span class="fu">log1p</span>(Right.turn.intensity12))</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>train2)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> train2<span class="sc">$</span>NB_Claim</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fu">log</span>(train2<span class="sc">$</span>expo)</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>lambda.min <span class="ot">&lt;-</span> <span class="fl">3.981072e-05</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>lasso.min <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(matrix.x, y, <span class="at">family =</span> <span class="st">"poisson"</span>, <span class="at">relax=</span><span class="cn">FALSE</span>, <span class="at">offset =</span> offset, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> lambda.min)</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>train2<span class="sc">$</span>pred.tele <span class="ot">&lt;-</span> <span class="fu">predict</span>(lasso.min, <span class="at">newx =</span> matrix.x, <span class="at">type=</span><span class="st">'response'</span>, <span class="at">newoffset=</span>offset, <span class="at">lambda =</span> lambda.min)</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>test2)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> test2<span class="sc">$</span>NB_Claim</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fu">log</span>(test2<span class="sc">$</span>expo)</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>test2<span class="sc">$</span>pred.tele <span class="ot">&lt;-</span> <span class="fu">predict</span>(lasso.min, <span class="at">newx =</span> matrix.x, <span class="at">type=</span><span class="st">'response'</span>, <span class="at">newoffset=</span>offset, <span class="at">lambda =</span> lambda.min)</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>glm.score <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Insured.sex <span class="sc">+</span> Marital </span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">+</span> Credit.score <span class="sc">+</span>  <span class="fu">I</span>(Credit.score<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">+</span> Insured.age <span class="sc">+</span>  <span class="fu">log</span>(Insured.age) <span class="sc">+</span> <span class="fu">I</span>(Insured.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">+</span> terr.code <span class="sc">+</span> <span class="fu">I</span>(terr.code<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(terr.code<span class="sc">^</span><span class="dv">3</span>) )</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>train2)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> train2<span class="sc">$</span>NB_Claim</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fu">log</span>(train2<span class="sc">$</span>pred.tele)</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>lambda.min <span class="ot">&lt;-</span> <span class="fl">1e-08</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>lambda<span class="fl">.1</span>se <span class="ot">&lt;-</span> <span class="fl">0.007943282</span></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>lambda.select <span class="ot">&lt;-</span> lambda.min</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a><span class="co">#fit &lt;- glmnet(matrix.x, y, family = "poisson", relax=FALSE, offset = offset, alpha = 1, lambda = lambda.select)</span></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(matrix.x, y, <span class="at">family =</span> <span class="st">"poisson"</span>, <span class="at">relax=</span><span class="cn">TRUE</span>, <span class="at">offset =</span> offset, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>test2)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> test2<span class="sc">$</span>NB_Claim</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fu">log</span>(test2<span class="sc">$</span>pred.tele)</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>test2<span class="sc">$</span>pred.base <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newx =</span> matrix.x, <span class="at">type=</span><span class="st">'response'</span>, <span class="at">newoffset=</span>offset, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">Score.pred</span>(test2<span class="sc">$</span>pred.base, test2<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">nrow</span>(test2)))</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="st">'LASSO* (optimal)'</span>, Result_)</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>Result_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_all, Result_)</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>glm.score <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(NB_Claim <span class="sc">~</span> Insured.sex <span class="sc">+</span> Marital </span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">+</span> Credit.score <span class="sc">+</span>  <span class="fu">I</span>(Credit.score<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">+</span> Insured.age <span class="sc">+</span>  <span class="fu">log</span>(Insured.age) <span class="sc">+</span> <span class="fu">I</span>(Insured.age<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">+</span> terr.code <span class="sc">+</span> <span class="fu">I</span>(terr.code<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">I</span>(terr.code<span class="sc">^</span><span class="dv">3</span>) )</span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>train2)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> train2<span class="sc">$</span>NB_Claim</span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fu">log</span>(train2<span class="sc">$</span>pred.tele)</span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>lambda.min <span class="ot">&lt;-</span> <span class="fl">1e-08</span></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>lambda<span class="fl">.1</span>se <span class="ot">&lt;-</span> <span class="fl">0.007943282</span></span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a>lambda.select <span class="ot">&lt;-</span> lambda<span class="fl">.1</span>se</span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(matrix.x, y, <span class="at">family =</span> <span class="st">"poisson"</span>, <span class="at">relax=</span><span class="cn">FALSE</span>, <span class="at">offset =</span> offset, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a><span class="co">#fit &lt;- glmnet(matrix.x, y, family = "poisson", relax=TRUE, offset = offset, alpha = 1, lambda = lambda.select)</span></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a>matrix.x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(glm.score, <span class="at">data=</span>test2)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> test2<span class="sc">$</span>NB_Claim</span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fu">log</span>(test2<span class="sc">$</span>pred.tele)</span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a>test2<span class="sc">$</span>pred.base <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newx =</span> matrix.x, <span class="at">type=</span><span class="st">'response'</span>, <span class="at">newoffset=</span>offset, <span class="at">lambda =</span> lambda.select)</span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">Score.pred</span>(test2<span class="sc">$</span>pred.base, test2<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">nrow</span>(test2)))</span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="st">'LASSO* (parsimonious)'</span>, Result_)</span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a>Result_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_all, Result_)</span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Result_all, <span class="at">align =</span> <span class="st">"ccccccc"</span>, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>), <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>))<span class="sc">%&gt;%</span>   </span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> T)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-Pscore_basetest4b" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.10: Prediction scores for the GLM-net model (testing set)</caption>
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.log</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.MSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.quad</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.sph</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.DSS</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.CRPS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Base</td>
<td style="text-align: center;">0.17674</td>
<td style="text-align: center;">0.04545</td>
<td style="text-align: center;">-0.92147</td>
<td style="text-align: center;">-0.95981</td>
<td style="text-align: center;">-2.19876</td>
<td style="text-align: center;">0.04127</td>
</tr>
<tr class="even">
<td style="text-align: center;">GLM (trad.)</td>
<td style="text-align: center;">0.17359</td>
<td style="text-align: center;">0.04514</td>
<td style="text-align: center;">-0.92197</td>
<td style="text-align: center;">-0.95995</td>
<td style="text-align: center;">-2.27716</td>
<td style="text-align: center;">0.04099</td>
</tr>
<tr class="odd">
<td style="text-align: center;">LASSO (optimal)</td>
<td style="text-align: center;">0.15536</td>
<td style="text-align: center;">0.04239</td>
<td style="text-align: center;">-0.92624</td>
<td style="text-align: center;">-0.96135</td>
<td style="text-align: center;">-2.69596</td>
<td style="text-align: center;">0.03866</td>
</tr>
<tr class="even">
<td style="text-align: center;">LASSO (parsimonious)</td>
<td style="text-align: center;">0.15704</td>
<td style="text-align: center;">0.04261</td>
<td style="text-align: center;">-0.92579</td>
<td style="text-align: center;">-0.96120</td>
<td style="text-align: center;">-2.70016</td>
<td style="text-align: center;">0.03889</td>
</tr>
<tr class="odd">
<td style="text-align: center;">LASSO* (optimal)</td>
<td style="text-align: center;">0.15373</td>
<td style="text-align: center;">0.04209</td>
<td style="text-align: center;">-0.92677</td>
<td style="text-align: center;">-0.96154</td>
<td style="text-align: center;">-2.62254</td>
<td style="text-align: center;">0.03837</td>
</tr>
<tr class="even">
<td style="text-align: center;">LASSO* (parsimonious)</td>
<td style="text-align: center;">0.15481</td>
<td style="text-align: center;">0.04226</td>
<td style="text-align: center;">-0.92642</td>
<td style="text-align: center;">-0.96142</td>
<td style="text-align: center;">-2.69780</td>
<td style="text-align: center;">0.03855</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="xgboost" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="xgboost"><span class="header-section-number">4.4</span> XGBoost</h2>
<p>We now consider an XGBoost model. As with the frequency model, hyperparameter values are obtained by performing a Bayesian search on a grid of possible values.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true">Prediction Scores</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false">Variables Importance</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-3" role="tab" aria-controls="tabset-5-3" aria-selected="false">RESIDUALS AND PROTECTED VARIABLES</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-4" role="tab" aria-controls="tabset-5-4" aria-selected="false">XGBOOST ON RESIDUALS</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<p>We can calculate the model’s prediction scores based on all classical and telematics covariates. The XGBoost approach is particularly effective in capturing the effect of all available telematic covariates. Indeed, the scores obtained are significantly improved compared to other tested approaches.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta =</span> <span class="fl">0.02337437</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_depth =</span> <span class="dv">26</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">subsample =</span> <span class="fl">0.8097923</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_child_weight =</span> <span class="dv">1</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">booster =</span> <span class="st">"gbtree"</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> <span class="st">"count:poisson"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">eval_metric =</span> <span class="st">"poisson-nloglik"</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">133</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>xgbcv <span class="ot">&lt;-</span> <span class="fu">xgb.cv</span>(<span class="at">params =</span> param,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">nrounds =</span> <span class="dv">367</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> dtrain,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">folds =</span> folds,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">prediction =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>                <span class="at">early_stopping_rounds =</span> <span class="dv">10</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>                <span class="at">verbose =</span> <span class="dv">0</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>                <span class="at">maximize =</span> F)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>Sc.log <span class="ot">&lt;-</span> <span class="fu">sapply</span>(xgbcv<span class="sc">$</span>folds, <span class="cf">function</span>(x){<span class="sc">-</span><span class="fu">dpois</span>(train2<span class="sc">$</span>NB_Claim[x], <span class="fu">unlist</span>(xgbcv<span class="sc">$</span>pred[x]), <span class="at">log=</span><span class="cn">TRUE</span>)})</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>Sc.MSE <span class="ot">&lt;-</span> <span class="fu">sapply</span>(xgbcv<span class="sc">$</span>folds, <span class="cf">function</span>(x){(train2<span class="sc">$</span>NB_Claim[x]<span class="sc">-</span><span class="fu">unlist</span>(xgbcv<span class="sc">$</span>pred[x]))<span class="sc">^</span><span class="dv">2</span>})</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>Sc.quad <span class="ot">&lt;-</span> <span class="fu">sapply</span>(xgbcv<span class="sc">$</span>folds, <span class="cf">function</span>(x){</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  nb <span class="ot">&lt;-</span> train2<span class="sc">$</span>NB_Claim[x]</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">unlist</span>(xgbcv<span class="sc">$</span>pred[x])</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="dv">2</span><span class="sc">*</span><span class="fu">dpois</span>(nb,<span class="at">lambda=</span>mu) <span class="sc">+</span> <span class="fu">dpois</span>(<span class="dv">0</span>,<span class="at">lambda=</span>mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">dpois</span>(<span class="dv">1</span>,<span class="at">lambda=</span>mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">dpois</span>(<span class="dv">2</span>,<span class="at">lambda=</span>mu)<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span> <span class="fu">dpois</span>(<span class="dv">3</span>,<span class="at">lambda=</span>mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">dpois</span>(<span class="dv">4</span>,<span class="at">lambda=</span>mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">dpois</span>(<span class="dv">5</span>,<span class="at">lambda=</span>mu)<span class="sc">^</span><span class="dv">2</span> </span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>})  </span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>Sc.sph <span class="ot">&lt;-</span> <span class="fu">sapply</span>(xgbcv<span class="sc">$</span>folds, <span class="cf">function</span>(x){</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  nb <span class="ot">&lt;-</span> train2<span class="sc">$</span>NB_Claim[x]</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">unlist</span>(xgbcv<span class="sc">$</span>pred[x])</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">dpois</span>(nb,<span class="at">lambda=</span>mu) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">dpois</span>(<span class="dv">0</span>,<span class="at">lambda=</span>mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">dpois</span>(<span class="dv">1</span>,<span class="at">lambda=</span>mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">dpois</span>(<span class="dv">2</span>,<span class="at">lambda=</span>mu)<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span> <span class="fu">dpois</span>(<span class="dv">3</span>,<span class="at">lambda=</span>mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">dpois</span>(<span class="dv">4</span>,<span class="at">lambda=</span>mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">dpois</span>(<span class="dv">5</span>,<span class="at">lambda=</span>mu)<span class="sc">^</span><span class="dv">2</span> ) </span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>Sc.DSS <span class="ot">&lt;-</span> <span class="fu">sapply</span>(xgbcv<span class="sc">$</span>folds, <span class="cf">function</span>(x){<span class="fu">dss_pois</span>(train2<span class="sc">$</span>NB_Claim[x], <span class="fu">unlist</span>(xgbcv<span class="sc">$</span>pred[x]))})</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>Sc.CRPS <span class="ot">&lt;-</span> <span class="fu">sapply</span>(xgbcv<span class="sc">$</span>folds, <span class="cf">function</span>(x){<span class="fu">crps_pois</span>(train2<span class="sc">$</span>NB_Claim[x], <span class="fu">unlist</span>(xgbcv<span class="sc">$</span>pred[x]))})</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>Result_  <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="dv">1</span>,<span class="fu">mean</span>(Sc.log[<span class="dv">1</span>]<span class="sc">$</span>fold1), <span class="fu">mean</span>(Sc.MSE[<span class="dv">1</span>]<span class="sc">$</span>fold1), <span class="fu">mean</span>(Sc.quad[<span class="dv">1</span>]<span class="sc">$</span>fold1), <span class="fu">mean</span>(Sc.sph[<span class="dv">1</span>]<span class="sc">$</span>fold1), <span class="fu">mean</span>(Sc.DSS[<span class="dv">1</span>]<span class="sc">$</span>fold1), <span class="fu">mean</span>(Sc.CRPS[<span class="dv">1</span>]<span class="sc">$</span>fold1)),</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="dv">2</span>,<span class="fu">mean</span>(Sc.log[<span class="dv">2</span>]<span class="sc">$</span>fold2), <span class="fu">mean</span>(Sc.MSE[<span class="dv">2</span>]<span class="sc">$</span>fold2), <span class="fu">mean</span>(Sc.quad[<span class="dv">2</span>]<span class="sc">$</span>fold2), <span class="fu">mean</span>(Sc.sph[<span class="dv">2</span>]<span class="sc">$</span>fold2), <span class="fu">mean</span>(Sc.DSS[<span class="dv">2</span>]<span class="sc">$</span>fold2), <span class="fu">mean</span>(Sc.CRPS[<span class="dv">2</span>]<span class="sc">$</span>fold2)),</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="dv">3</span>,<span class="fu">mean</span>(Sc.log[<span class="dv">3</span>]<span class="sc">$</span>fold3), <span class="fu">mean</span>(Sc.MSE[<span class="dv">3</span>]<span class="sc">$</span>fold3), <span class="fu">mean</span>(Sc.quad[<span class="dv">3</span>]<span class="sc">$</span>fold3), <span class="fu">mean</span>(Sc.sph[<span class="dv">3</span>]<span class="sc">$</span>fold3), <span class="fu">mean</span>(Sc.DSS[<span class="dv">3</span>]<span class="sc">$</span>fold3), <span class="fu">mean</span>(Sc.CRPS[<span class="dv">3</span>]<span class="sc">$</span>fold3)),</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="dv">4</span>,<span class="fu">mean</span>(Sc.log[<span class="dv">4</span>]<span class="sc">$</span>fold4), <span class="fu">mean</span>(Sc.MSE[<span class="dv">4</span>]<span class="sc">$</span>fold4), <span class="fu">mean</span>(Sc.quad[<span class="dv">4</span>]<span class="sc">$</span>fold4), <span class="fu">mean</span>(Sc.sph[<span class="dv">4</span>]<span class="sc">$</span>fold4), <span class="fu">mean</span>(Sc.DSS[<span class="dv">4</span>]<span class="sc">$</span>fold4), <span class="fu">mean</span>(Sc.CRPS[<span class="dv">4</span>]<span class="sc">$</span>fold4)),</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="dv">5</span>,<span class="fu">mean</span>(Sc.log[<span class="dv">5</span>]<span class="sc">$</span>fold5), <span class="fu">mean</span>(Sc.MSE[<span class="dv">5</span>]<span class="sc">$</span>fold5), <span class="fu">mean</span>(Sc.quad[<span class="dv">5</span>]<span class="sc">$</span>fold5), <span class="fu">mean</span>(Sc.sph[<span class="dv">5</span>]<span class="sc">$</span>fold5), <span class="fu">mean</span>(Sc.DSS[<span class="dv">5</span>]<span class="sc">$</span>fold5), <span class="fu">mean</span>(Sc.CRPS[<span class="dv">5</span>]<span class="sc">$</span>fold5))</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>Res.sum  <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">sum</span>(Sc.log[<span class="dv">1</span>]<span class="sc">$</span>fold1), <span class="fu">sum</span>(Sc.MSE[<span class="dv">1</span>]<span class="sc">$</span>fold1), <span class="fu">sum</span>(Sc.quad[<span class="dv">1</span>]<span class="sc">$</span>fold1), <span class="fu">sum</span>(Sc.sph[<span class="dv">1</span>]<span class="sc">$</span>fold1), <span class="fu">sum</span>(Sc.DSS[<span class="dv">1</span>]<span class="sc">$</span>fold1), <span class="fu">sum</span>(Sc.CRPS[<span class="dv">1</span>]<span class="sc">$</span>fold1)),</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">sum</span>(Sc.log[<span class="dv">2</span>]<span class="sc">$</span>fold2), <span class="fu">sum</span>(Sc.MSE[<span class="dv">2</span>]<span class="sc">$</span>fold2), <span class="fu">sum</span>(Sc.quad[<span class="dv">2</span>]<span class="sc">$</span>fold2), <span class="fu">sum</span>(Sc.sph[<span class="dv">2</span>]<span class="sc">$</span>fold2), <span class="fu">sum</span>(Sc.DSS[<span class="dv">2</span>]<span class="sc">$</span>fold2), <span class="fu">sum</span>(Sc.CRPS[<span class="dv">2</span>]<span class="sc">$</span>fold2)),</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">sum</span>(Sc.log[<span class="dv">3</span>]<span class="sc">$</span>fold3), <span class="fu">sum</span>(Sc.MSE[<span class="dv">3</span>]<span class="sc">$</span>fold3), <span class="fu">sum</span>(Sc.quad[<span class="dv">3</span>]<span class="sc">$</span>fold3), <span class="fu">sum</span>(Sc.sph[<span class="dv">3</span>]<span class="sc">$</span>fold3), <span class="fu">sum</span>(Sc.DSS[<span class="dv">3</span>]<span class="sc">$</span>fold3), <span class="fu">sum</span>(Sc.CRPS[<span class="dv">3</span>]<span class="sc">$</span>fold3)),</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">sum</span>(Sc.log[<span class="dv">4</span>]<span class="sc">$</span>fold4), <span class="fu">sum</span>(Sc.MSE[<span class="dv">4</span>]<span class="sc">$</span>fold4), <span class="fu">sum</span>(Sc.quad[<span class="dv">4</span>]<span class="sc">$</span>fold4), <span class="fu">sum</span>(Sc.sph[<span class="dv">4</span>]<span class="sc">$</span>fold4), <span class="fu">sum</span>(Sc.DSS[<span class="dv">4</span>]<span class="sc">$</span>fold4), <span class="fu">sum</span>(Sc.CRPS[<span class="dv">4</span>]<span class="sc">$</span>fold4)),</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">sum</span>(Sc.log[<span class="dv">5</span>]<span class="sc">$</span>fold5), <span class="fu">sum</span>(Sc.MSE[<span class="dv">5</span>]<span class="sc">$</span>fold5), <span class="fu">sum</span>(Sc.quad[<span class="dv">5</span>]<span class="sc">$</span>fold5), <span class="fu">sum</span>(Sc.sph[<span class="dv">5</span>]<span class="sc">$</span>fold5), <span class="fu">sum</span>(Sc.DSS[<span class="dv">5</span>]<span class="sc">$</span>fold5), <span class="fu">sum</span>(Sc.CRPS[<span class="dv">5</span>]<span class="sc">$</span>fold5))</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>sum <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Total'</span>, <span class="fu">colSums</span>(Res.sum)<span class="sc">/</span><span class="fu">nrow</span>(train2))</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>Result_  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">rbind</span>(Result_, sum)) </span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a><span class="do">## Show results</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Fold'</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_, Base)</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>Result_[nb.fold<span class="sc">+</span><span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">'Improvement'</span></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>){</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>  Result_[,i] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(Result_[,i])  </span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>  Result_[nb.fold<span class="sc">+</span><span class="dv">2</span>,i] <span class="ot">&lt;-</span>  Result_[nb.fold<span class="sc">+</span><span class="dv">1</span>,i] <span class="sc">-</span> Result_[nb.fold<span class="sc">+</span><span class="dv">2</span>,i]</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(Result_) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Result_, <span class="at">align =</span> <span class="st">"ccccccc"</span>, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>), <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>))<span class="sc">%&gt;%</span>   </span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> T)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-Pscore_XGBoosttele" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.11: Prediction scores for the XGBoost model with telematics</caption>
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Fold</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.log</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.MSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.quad</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.sph</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.DSS</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.CRPS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.13388</td>
<td style="text-align: center;">0.03521</td>
<td style="text-align: center;">-0.93284</td>
<td style="text-align: center;">-0.96351</td>
<td style="text-align: center;">-3.06883</td>
<td style="text-align: center;">0.03421</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">0.12792</td>
<td style="text-align: center;">0.03257</td>
<td style="text-align: center;">-0.93583</td>
<td style="text-align: center;">-0.96499</td>
<td style="text-align: center;">-3.15351</td>
<td style="text-align: center;">0.03241</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.12411</td>
<td style="text-align: center;">0.03254</td>
<td style="text-align: center;">-0.93948</td>
<td style="text-align: center;">-0.96697</td>
<td style="text-align: center;">-3.12854</td>
<td style="text-align: center;">0.03113</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">0.14126</td>
<td style="text-align: center;">0.03757</td>
<td style="text-align: center;">-0.92850</td>
<td style="text-align: center;">-0.96108</td>
<td style="text-align: center;">-3.03608</td>
<td style="text-align: center;">0.03648</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.13492</td>
<td style="text-align: center;">0.03562</td>
<td style="text-align: center;">-0.93262</td>
<td style="text-align: center;">-0.96335</td>
<td style="text-align: center;">-3.05897</td>
<td style="text-align: center;">0.03442</td>
</tr>
<tr class="even">
<td style="text-align: center;">Total</td>
<td style="text-align: center;">0.13241</td>
<td style="text-align: center;">0.03470</td>
<td style="text-align: center;">-0.93386</td>
<td style="text-align: center;">-0.96398</td>
<td style="text-align: center;">-3.08921</td>
<td style="text-align: center;">0.03373</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Improvement</td>
<td style="text-align: center;">-0.05138</td>
<td style="text-align: center;">-0.01306</td>
<td style="text-align: center;">-0.01611</td>
<td style="text-align: center;">-0.00611</td>
<td style="text-align: center;">-0.95232</td>
<td style="text-align: center;">-0.00954</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>On the <em>test</em> set, we obtain:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>dtrain <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">data.matrix</span>(train2[, <span class="fu">paste</span>(all.vars2)]), <span class="at">label =</span> train2<span class="sc">$</span>NB_Claim)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setinfo</span>(dtrain,<span class="st">"base_margin"</span>,<span class="fu">log</span>(train2<span class="sc">$</span>expo))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>dtest <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">data.matrix</span>(test2[, <span class="fu">paste</span>(all.vars2)]), <span class="at">label =</span> test2<span class="sc">$</span>NB_Claim)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">setinfo</span>(dtest,<span class="st">"base_margin"</span>,<span class="fu">log</span>(test2<span class="sc">$</span>expo))</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">fold1 =</span> <span class="fu">which</span>(train2<span class="sc">$</span>fold <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">fold2 =</span> <span class="fu">which</span>(train2<span class="sc">$</span>fold <span class="sc">==</span> <span class="dv">2</span>),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">fold3 =</span> <span class="fu">which</span>(train2<span class="sc">$</span>fold <span class="sc">==</span> <span class="dv">3</span>),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">fold4 =</span> <span class="fu">which</span>(train2<span class="sc">$</span>fold <span class="sc">==</span> <span class="dv">4</span>),</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">fold5 =</span> <span class="fu">which</span>(train2<span class="sc">$</span>fold <span class="sc">==</span> <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta =</span> <span class="fl">0.02337437</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_depth =</span> <span class="dv">26</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">subsample =</span> <span class="fl">0.8097923</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_child_weight =</span> <span class="dv">1</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">booster =</span> <span class="st">"gbtree"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> <span class="st">"count:poisson"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">eval_metric =</span> <span class="st">"poisson-nloglik"</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">133</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>fit.xgb <span class="ot">&lt;-</span> <span class="fu">xgb.train</span>(<span class="at">params =</span> param,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nrounds =</span> <span class="dv">367</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> dtrain)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>train2<span class="sc">$</span>pred.xgb <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.xgb, dtrain, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>test2<span class="sc">$</span>pred.xgb <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.xgb, dtest, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>test2<span class="sc">$</span>pred.base <span class="ot">&lt;-</span> test2<span class="sc">$</span>pred.xgb</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">Score.pred</span>(test2<span class="sc">$</span>pred.base, test2<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">nrow</span>(test2)))</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="st">'XGBoost'</span>, Result_)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>Result_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_all, Result_)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Result_all, <span class="at">align =</span> <span class="st">"ccccccc"</span>, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>), <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>))<span class="sc">%&gt;%</span>   </span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> T)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-Pscore_XGBoost_correction333" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.12: Prediction scores for the XGBoost model with telematics</caption>
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.log</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.MSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.quad</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.sph</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.DSS</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.CRPS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Base</td>
<td style="text-align: center;">0.17674</td>
<td style="text-align: center;">0.04545</td>
<td style="text-align: center;">-0.92147</td>
<td style="text-align: center;">-0.95981</td>
<td style="text-align: center;">-2.19876</td>
<td style="text-align: center;">0.04127</td>
</tr>
<tr class="even">
<td style="text-align: center;">GLM (trad.)</td>
<td style="text-align: center;">0.17359</td>
<td style="text-align: center;">0.04514</td>
<td style="text-align: center;">-0.92197</td>
<td style="text-align: center;">-0.95995</td>
<td style="text-align: center;">-2.27716</td>
<td style="text-align: center;">0.04099</td>
</tr>
<tr class="odd">
<td style="text-align: center;">LASSO (optimal)</td>
<td style="text-align: center;">0.15536</td>
<td style="text-align: center;">0.04239</td>
<td style="text-align: center;">-0.92624</td>
<td style="text-align: center;">-0.96135</td>
<td style="text-align: center;">-2.69596</td>
<td style="text-align: center;">0.03866</td>
</tr>
<tr class="even">
<td style="text-align: center;">LASSO (parsimonious)</td>
<td style="text-align: center;">0.15704</td>
<td style="text-align: center;">0.04261</td>
<td style="text-align: center;">-0.92579</td>
<td style="text-align: center;">-0.96120</td>
<td style="text-align: center;">-2.70016</td>
<td style="text-align: center;">0.03889</td>
</tr>
<tr class="odd">
<td style="text-align: center;">LASSO* (optimal)</td>
<td style="text-align: center;">0.15373</td>
<td style="text-align: center;">0.04209</td>
<td style="text-align: center;">-0.92677</td>
<td style="text-align: center;">-0.96154</td>
<td style="text-align: center;">-2.62254</td>
<td style="text-align: center;">0.03837</td>
</tr>
<tr class="even">
<td style="text-align: center;">LASSO* (parsimonious)</td>
<td style="text-align: center;">0.15481</td>
<td style="text-align: center;">0.04226</td>
<td style="text-align: center;">-0.92642</td>
<td style="text-align: center;">-0.96142</td>
<td style="text-align: center;">-2.69780</td>
<td style="text-align: center;">0.03855</td>
</tr>
<tr class="odd">
<td style="text-align: center;">XGBoost</td>
<td style="text-align: center;">0.12142</td>
<td style="text-align: center;">0.03110</td>
<td style="text-align: center;">-0.93907</td>
<td style="text-align: center;">-0.96656</td>
<td style="text-align: center;">-3.21523</td>
<td style="text-align: center;">0.03081</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<p>The graph below illustrates the most critical variables in the XGBoost model for claim frequency. As indicated in the literature, the level of vehicle usage, represented here by the daily mileage, is the most crucial variable in the model. Driving experience, measured by the number of claim-free years, follows. To a lesser extent, a series of telematic variables also has predictive capability.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>importance_matrix <span class="ot">&lt;-</span> <span class="fu">xgb.importance</span>(<span class="fu">dimnames</span>(dtrain)[[<span class="dv">2</span>]], <span class="at">model =</span> fit.xgb)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.ggplot.importance</span>(importance_matrix,<span class="at">top_n=</span><span class="dv">15</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="VarTelematiques_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<div id="tabset-5-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-3-tab">
<p>As we did for the GLM-Net approach, we can again analyze the residuals of the approach to see if the addition of telematic data eliminates the need to use protected variables. The graphs below show that XGBoost is even more effective than GLM-Net. Indeed, although the credit score still appears useful in modeling frequency, its effect is greatly diminished. The effects of age, gender, and marital status of the insured are also significantly reduced. Finally, we can even see that the effect of territory is also greatly minimized.</p>
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>meaninv  <span class="ot">&lt;-</span> <span class="fu">sum</span>(train2<span class="sc">$</span>expo)<span class="sc">/</span><span class="fu">sum</span>(train2<span class="sc">$</span>NB_Claim)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>moy.xgb <span class="ot">&lt;-</span> <span class="fu">sum</span>(train2<span class="sc">$</span>pred.xgb)<span class="sc">/</span><span class="fu">sum</span>(train2<span class="sc">$</span>NB_Claim)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>temp2 <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Duration.y =</span> Duration<span class="sc">/</span><span class="fl">365.25</span>, </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">Insured.age =</span> <span class="fu">pmin</span>(Insured.age, <span class="dv">80</span>),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">Group =</span> <span class="fu">ceiling</span>(Credit.score<span class="sc">/</span><span class="dv">25</span>) <span class="sc">*</span> <span class="dv">25</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Group) <span class="sc">%&gt;%</span> </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">NB_Claim=</span><span class="fu">sum</span>(NB_Claim),</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo=</span><span class="fu">sum</span>(expo),</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo2=</span><span class="fu">sum</span>(pred.xgb)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">freq =</span> meaninv<span class="sc">*</span>NB_Claim<span class="sc">/</span>expo, </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq2 =</span>  moy.xgb<span class="sc">*</span>NB_Claim<span class="sc">/</span>expo2)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>Graph_resCS <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">x=</span>Group, <span class="at">y=</span>freq, <span class="at">weight =</span> expo, <span class="at">color=</span><span class="st">'Observed'</span>),<span class="at">se=</span>F, <span class="at">size=</span><span class="dv">1</span>, <span class="at">data=</span>temp2) <span class="sc">+</span> </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">x=</span>Group, <span class="at">y=</span>freq2, <span class="at">weight =</span> expo, <span class="at">color=</span><span class="st">'Residuals'</span>),<span class="at">se=</span>F, <span class="at">size=</span><span class="dv">1</span>, <span class="at">data=</span>temp2) <span class="sc">+</span> </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Credit Score'</span>,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>)<span class="sc">+</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Graph_resCS)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(Graph_resCS, <span class="at">file =</span> <span class="st">"Data/Graph_resCS.rdata"</span>)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="do">### Age of the insured</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>temp2 <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Duration.y =</span> Duration<span class="sc">/</span><span class="fl">365.25</span>, </span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>                <span class="at">Insured.age =</span> <span class="fu">pmin</span>(Insured.age, <span class="dv">80</span>), </span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>                <span class="at">Group =</span> <span class="fu">ceiling</span>(Insured.age<span class="sc">/</span><span class="dv">5</span>) <span class="sc">*</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Group) <span class="sc">%&gt;%</span> </span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">NB_Claim=</span><span class="fu">sum</span>(NB_Claim),</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo=</span><span class="fu">sum</span>(expo),</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo2=</span><span class="fu">sum</span>(pred.xgb)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">freq =</span> meaninv<span class="sc">*</span>NB_Claim<span class="sc">/</span>expo, </span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq2 =</span>  moy.xgb<span class="sc">*</span>NB_Claim<span class="sc">/</span>expo2)</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>Graph_resAge <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">x=</span>Group, <span class="at">y=</span>freq, <span class="at">weight =</span> expo, <span class="at">color=</span><span class="st">'Observed'</span>),<span class="at">se=</span>F, <span class="at">size=</span><span class="dv">1</span>, <span class="at">data=</span>temp2) <span class="sc">+</span> </span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">x=</span>Group, <span class="at">y=</span>freq2, <span class="at">weight =</span> expo, <span class="at">color=</span><span class="st">'Residuals'</span>),<span class="at">se=</span>F, <span class="at">size=</span><span class="dv">1</span>, <span class="at">data=</span>temp2) <span class="sc">+</span> </span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Age of the insured'</span>,</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>)<span class="sc">+</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Graph_resAge)</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(Graph_resAge, <span class="at">file =</span> <span class="st">"Data/Graph_resAge.rdata"</span>)</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a><span class="do">### Sex of the insured</span></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Var_ =</span> Insured.sex) <span class="sc">%&gt;%</span></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Var_) <span class="sc">%&gt;%</span></span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">nbclaim =</span> <span class="fu">sum</span>(NB_Claim),</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo =</span> <span class="fu">sum</span>(expo),</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo2 =</span> <span class="fu">sum</span>(pred.xgb)) <span class="sc">%&gt;%</span></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">freq =</span> nbclaim<span class="sc">/</span>expo,</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq2 =</span> nbclaim<span class="sc">/</span>expo2)</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>temp<span class="sc">$</span>freq <span class="ot">&lt;-</span> temp<span class="sc">$</span>freq<span class="sc">/</span>temp<span class="sc">$</span>freq[<span class="dv">1</span>]</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>temp<span class="sc">$</span>freq2 <span class="ot">&lt;-</span> temp<span class="sc">$</span>freq2<span class="sc">/</span>temp<span class="sc">$</span>freq2[<span class="dv">1</span>]</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="co">#start plot by by plotting bars</span></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq2), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Residuals'</span>), <span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq2), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Residuals'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Observed'</span>), <span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Observed'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Sex of the insured'</span>, <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>)<span class="sc">+</span></span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">max</span>(temp<span class="sc">$</span>freq, temp<span class="sc">$</span>freq2)<span class="sc">*</span><span class="fl">0.95</span>, <span class="fu">max</span>(temp<span class="sc">$</span>freq, temp<span class="sc">$</span>freq2)<span class="sc">*</span><span class="fl">1.05</span>)<span class="sc">+</span></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">title=</span><span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a><span class="do">### Marital Status</span></span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Var_ =</span> Marital) <span class="sc">%&gt;%</span></span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Var_) <span class="sc">%&gt;%</span></span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">nbclaim =</span> <span class="fu">sum</span>(NB_Claim),</span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo =</span> <span class="fu">sum</span>(expo),</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo2 =</span> <span class="fu">sum</span>(pred.xgb)) <span class="sc">%&gt;%</span></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">freq =</span> nbclaim<span class="sc">/</span>expo, </span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq2 =</span> nbclaim<span class="sc">/</span>expo2)</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>temp<span class="sc">$</span>freq <span class="ot">&lt;-</span> temp<span class="sc">$</span>freq<span class="sc">/</span>temp<span class="sc">$</span>freq[<span class="dv">1</span>]</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>temp<span class="sc">$</span>freq2 <span class="ot">&lt;-</span> temp<span class="sc">$</span>freq2<span class="sc">/</span>temp<span class="sc">$</span>freq2[<span class="dv">1</span>]</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="co">#start plot by by plotting bars</span></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq2), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Residuals'</span>), <span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq2), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Residuals'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Observed'</span>), <span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> (freq), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Observed'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Marital status of the insured'</span>, <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>)<span class="sc">+</span></span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">0.9</span>, <span class="fu">max</span>(temp<span class="sc">$</span>freq, temp<span class="sc">$</span>freq2)<span class="sc">*</span><span class="fl">1.2</span>)<span class="sc">+</span></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">title=</span><span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a><span class="do">### Insured's territory</span></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Var_ =</span> Territory) <span class="sc">%&gt;%</span></span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Var_) <span class="sc">%&gt;%</span></span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">nbclaim =</span> <span class="fu">sum</span>(NB_Claim),</span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo =</span> <span class="fu">sum</span>(expo),</span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo2 =</span> <span class="fu">sum</span>(pred.xgb)) <span class="sc">%&gt;%</span></span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">freq =</span> moy.xgb<span class="sc">*</span>nbclaim<span class="sc">/</span>expo2)</span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a>temp2 <span class="ot">&lt;-</span> train2 <span class="sc">%&gt;%</span></span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Var_ =</span> Territory) <span class="sc">%&gt;%</span></span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Var_) <span class="sc">%&gt;%</span></span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">nbclaim =</span> <span class="fu">sum</span>(NB_Claim),</span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a>            <span class="at">expo =</span> <span class="fu">sum</span>(expo)) <span class="sc">%&gt;%</span></span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">freq =</span> meaninv<span class="sc">*</span>nbclaim<span class="sc">/</span>expo)</span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>Graph_resTerr <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> freq, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Residuals'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> freq, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Residuals'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> temp2, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> freq, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Observed'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> temp2, <span class="fu">aes</span>(<span class="at">x =</span> Var_, <span class="at">y =</span> freq, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color=</span><span class="st">'Observed'</span>), <span class="at">size=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>)<span class="sc">+</span></span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'Territory'</span>,</span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Relativity'</span>) <span class="sc">+</span></span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> <span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>)<span class="sc">+</span></span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">title=</span><span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>)</span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Graph_resTerr)</span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(Graph_resTerr, <span class="at">file =</span> <span class="st">"Data/Graph_resTerr.rdata"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-CreditScore_sev2" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-CreditScore_sev2-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-CreditScore_sev2-1.png" class="img-fluid figure-img" data-ref-parent="fig-CreditScore_sev2" width="864"></p>
<figcaption class="figure-caption">(a) Credit Score</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-CreditScore_sev2-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-CreditScore_sev2-2.png" class="img-fluid figure-img" data-ref-parent="fig-CreditScore_sev2" width="864"></p>
<figcaption class="figure-caption">(b) Age of the Insured</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-CreditScore_sev2-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-CreditScore_sev2-3.png" class="img-fluid figure-img" data-ref-parent="fig-CreditScore_sev2" width="864"></p>
<figcaption class="figure-caption">(c) Sex of the Insured</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-CreditScore_sev2-4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-CreditScore_sev2-4.png" class="img-fluid figure-img" data-ref-parent="fig-CreditScore_sev2" width="864"></p>
<figcaption class="figure-caption">(d) Marital Status of the Insured</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-CreditScore_sev2-5" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="VarTelematiques_files/figure-html/fig-CreditScore_sev2-5.png" class="img-fluid figure-img" data-ref-parent="fig-CreditScore_sev2" width="864"></p>
<figcaption class="figure-caption">(e) Territory</figcaption>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;4.5: Observed Relativity vs.&nbsp;Residuals Relativity</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div id="tabset-5-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-4-tab">
<p>We repeat the same exercise we did with the GLM-Net approach: fitting an XGBoost model on the residuals of the first XGBoost model. This will allow us to see if protected variables are capable of capturing trends in the approach’s residuals.</p>
<p>The table below shows the different scores for the XGBoost* model. There is only a gain on some of the indicated scores. Hence, telematics data can substitute protected variables based on the studied dataset.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Ckmeans<span class="fl">.1</span>d.dp)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SHAPforxgboost)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pacman)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>var.sens <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Marital"</span>, <span class="st">"Insured.sex"</span>, <span class="st">"Credit.score"</span>, <span class="st">"Insured.age"</span>, <span class="st">"Territory"</span>)    </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>dtrain <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">data.matrix</span>(train2[, <span class="fu">paste</span>(var.sens)]), <span class="at">label =</span> train2<span class="sc">$</span>NB_Claim)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="fu">setinfo</span>(dtrain,<span class="st">"base_margin"</span>,<span class="fu">log</span>(train2<span class="sc">$</span>pred.xgb))</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">fold1 =</span> <span class="fu">which</span>(train2<span class="sc">$</span>fold <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">fold2 =</span> <span class="fu">which</span>(train2<span class="sc">$</span>fold <span class="sc">==</span> <span class="dv">2</span>),</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">fold3 =</span> <span class="fu">which</span>(train2<span class="sc">$</span>fold <span class="sc">==</span> <span class="dv">3</span>),</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">fold4 =</span> <span class="fu">which</span>(train2<span class="sc">$</span>fold <span class="sc">==</span> <span class="dv">4</span>),</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">fold5 =</span> <span class="fu">which</span>(train2<span class="sc">$</span>fold <span class="sc">==</span> <span class="dv">5</span>))</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta =</span> <span class="fl">0.2215803</span>,</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_depth =</span> <span class="dv">50</span>,</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">subsample =</span> <span class="fl">0.7623535</span>,</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_child_weight =</span> <span class="dv">1</span>,</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">booster =</span> <span class="st">"gbtree"</span>,</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> <span class="st">"count:poisson"</span>,</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">eval_metric =</span> <span class="st">"poisson-nloglik"</span>)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">533</span>)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>fit.xgb2 <span class="ot">&lt;-</span> <span class="fu">xgb.train</span>(<span class="at">params =</span> param,</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>                      <span class="at">nrounds =</span> <span class="dv">5</span>,</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> dtrain)</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>dtest <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> <span class="fu">data.matrix</span>(test2[, <span class="fu">paste</span>(var.sens)]), <span class="at">label =</span> test2<span class="sc">$</span>NB_Claim)</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="fu">setinfo</span>(dtest,<span class="st">"base_margin"</span>,<span class="fu">log</span>(test2<span class="sc">$</span>pred.xgb))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>test2<span class="sc">$</span>pred.base <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.xgb2, dtest, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">Score.pred</span>(test2<span class="sc">$</span>pred.base, test2<span class="sc">$</span>NB_Claim)<span class="sc">/</span><span class="fu">nrow</span>(test2)))</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>Result_ <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="st">'XGBoost*'</span>, Result_)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Result_) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Sc.log"</span>, <span class="st">"Sc.MSE"</span>, <span class="st">"Sc.quad"</span>, <span class="st">"Sc.sph"</span>, <span class="st">"Sc.DSS"</span>, <span class="st">"Sc.CRPS"</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>Result_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Result_all, Result_)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(Result_all, <span class="at">file=</span><span class="st">'Data/ResultsSynth.Rda'</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Result_all, <span class="at">align =</span> <span class="st">"ccccccc"</span>, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>), <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>))<span class="sc">%&gt;%</span>   </span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> T)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-Pscore_XGBoost_correction33" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.13: Prediction scores for the XGBoost model with telematics</caption>
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.log</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.MSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.quad</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.sph</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.DSS</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Sc.CRPS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Base</td>
<td style="text-align: center;">0.17674</td>
<td style="text-align: center;">0.04545</td>
<td style="text-align: center;">-0.92147</td>
<td style="text-align: center;">-0.95981</td>
<td style="text-align: center;">-2.19876</td>
<td style="text-align: center;">0.04127</td>
</tr>
<tr class="even">
<td style="text-align: center;">GLM (trad.)</td>
<td style="text-align: center;">0.17359</td>
<td style="text-align: center;">0.04514</td>
<td style="text-align: center;">-0.92197</td>
<td style="text-align: center;">-0.95995</td>
<td style="text-align: center;">-2.27716</td>
<td style="text-align: center;">0.04099</td>
</tr>
<tr class="odd">
<td style="text-align: center;">LASSO (optimal)</td>
<td style="text-align: center;">0.15536</td>
<td style="text-align: center;">0.04239</td>
<td style="text-align: center;">-0.92624</td>
<td style="text-align: center;">-0.96135</td>
<td style="text-align: center;">-2.69596</td>
<td style="text-align: center;">0.03866</td>
</tr>
<tr class="even">
<td style="text-align: center;">LASSO (parsimonious)</td>
<td style="text-align: center;">0.15704</td>
<td style="text-align: center;">0.04261</td>
<td style="text-align: center;">-0.92579</td>
<td style="text-align: center;">-0.96120</td>
<td style="text-align: center;">-2.70016</td>
<td style="text-align: center;">0.03889</td>
</tr>
<tr class="odd">
<td style="text-align: center;">LASSO* (optimal)</td>
<td style="text-align: center;">0.15373</td>
<td style="text-align: center;">0.04209</td>
<td style="text-align: center;">-0.92677</td>
<td style="text-align: center;">-0.96154</td>
<td style="text-align: center;">-2.62254</td>
<td style="text-align: center;">0.03837</td>
</tr>
<tr class="even">
<td style="text-align: center;">LASSO* (parsimonious)</td>
<td style="text-align: center;">0.15481</td>
<td style="text-align: center;">0.04226</td>
<td style="text-align: center;">-0.92642</td>
<td style="text-align: center;">-0.96142</td>
<td style="text-align: center;">-2.69780</td>
<td style="text-align: center;">0.03855</td>
</tr>
<tr class="odd">
<td style="text-align: center;">XGBoost</td>
<td style="text-align: center;">0.12142</td>
<td style="text-align: center;">0.03110</td>
<td style="text-align: center;">-0.93907</td>
<td style="text-align: center;">-0.96656</td>
<td style="text-align: center;">-3.21523</td>
<td style="text-align: center;">0.03081</td>
</tr>
<tr class="even">
<td style="text-align: center;">XGBoost*</td>
<td style="text-align: center;">0.12373</td>
<td style="text-align: center;">0.03250</td>
<td style="text-align: center;">-0.93737</td>
<td style="text-align: center;">-0.96579</td>
<td style="text-align: center;">-3.29489</td>
<td style="text-align: center;">0.03181</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>Although the XGBoost model on residuals does not yield significant gains, the graph below illustrates the most critical protected variables in the XGBoost model. It shows that the insured’s credit score and territory are the most critical variables in this model.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>importance_matrix <span class="ot">&lt;-</span> <span class="fu">xgb.importance</span>(<span class="fu">dimnames</span>(dtrain)[[<span class="dv">2</span>]], <span class="at">model =</span> fit.xgb2)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.ggplot.importance</span>(importance_matrix,<span class="at">top_n=</span><span class="dv">15</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="VarTelematiques_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./VarTraditionelles.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Traditional Covariates</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./severity.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Data Summary</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>